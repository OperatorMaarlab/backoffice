<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cambio de vuelos · Maarlab</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
<style>
  :root{
    --card:#ffffff; --ink:#0b2a5a; --sub:#475569; --border:#e2e8f0;
    --accent:#2bd9a7; --accent2:#40c8ff;
    --old:#fff5f5; --new:#ecfdf5; --muted:#eef2f7;
    --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;color:var(--ink);font:15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#fff;}
  /* Fondo Maarlab con velo más bajo (más color visible) */
  body::before{content:"";position:fixed;inset:0;z-index:-2;
    background:linear-gradient(135deg,var(--accent),var(--accent2));}
  body::after{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
    background:linear-gradient(to bottom, rgba(255,255,255,.42) 0%, rgba(255,255,255,.62) 45%, rgba(255,255,255,.86) 100%);}

  h1{font:700 22px/1.2 Poppins;margin:0}
  h2{font:700 16px/1.2 Poppins;margin:0 0 6px}
  .wrap{max-width:1240px;margin:0 auto;padding:16px}
  .bar{position:sticky;top:0;background:#ffffffbf;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:20}
  .flex{display:flex;gap:12px;align-items:center}
  .grow{flex:1}
  .btn{border:0;border-radius:12px;padding:10px 14px;color:#0b2a5a;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .chip button{padding:6px 10px;border:0;background:#f1f5f9;cursor:pointer;color:#0b2a5a}
  .chip button.active{background:#fff}
  .grid{display:grid;gap:16px}
  @media(min-width:1240px){.grid{grid-template-columns:470px 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px}
  label{font-size:12px;color:#334155;display:block;margin-bottom:8px}
  input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#0b2a5a}
  input[placeholder]{text-transform:uppercase}
  input.invalid{border-color:var(--bad)!important;background:#fff1f2}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .band{position:absolute;inset:0 0 auto 0;height:4px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .logoBoxSq{width:48px;height:48px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoBoxSq img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .tiny{font-size:11px;color:#64748b}

  .itins{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px}
  .itinCol{border:1px solid var(--border);border-radius:14px;padding:12px}
  .itinOld{background:var(--old)} .itinNew{background:var(--new)}
  .leg{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffb0;margin-top:10px}
  .legHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .legRoute .codes{font:700 18px Inter}
  .airLogoBox{height:36px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;min-width:90px}
  .airLogoBox img{max-height:100%;width:auto;display:block}
  .meta{font-size:12px;color:#475569}
  .times{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .big{font:700 18px Inter}
  .dim{font-size:12px;color:#334155;margin-top:6px}
  .delta span{font-weight:700}
  .delta .pos{color:var(--bad)} .delta .neg{color:var(--good)} .delta .zero{color:#64748b}

  .prices{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px}
  .pill{border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;background:var(--muted)}
  .pill .v{font-weight:700}
  .foot{display:flex;justify-content:space-between;gap:12px;margin-top:16px;color:#64748b;font-size:12px;align-items:center}
</style>
</head>
<body>
  <!-- TOP BAR -->
  <div class="bar">
    <div class="wrap flex">
      <div>
        <h1 id="pageTitle">Cambio de vuelos · Maarlab</h1>
        <div class="tiny" id="pageSubtitle">Itinerario anterior/nuevo · 4 vuelos · EUR/USD/MXN · PNG</div>
      </div>
      <div class="grow"></div>
      <div class="chip" id="chipLang" style="margin-right:8px">
        <button data-lang="es" class="active">ES</button>
        <button data-lang="en">EN</button>
      </div>
      <div class="chip" id="chipCurrency" style="margin-right:8px">
        <button data-cur="EUR" class="active">EUR</button>
        <button data-cur="USD">USD</button>
        <button data-cur="MXN">MXN</button>
      </div>
      <div class="logoBoxSq">
        <img alt="M" src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg" crossorigin="anonymous" referrerpolicy="no-referrer">
      </div>
    </div>
  </div>

  <div class="wrap grid">
    <!-- PANEL -->
    <div class="card" id="panel">
      <h2 id="hOut">Ruta (ida)</h2>
      <div class="row">
        <label id="lblOutFrom">Origen (IATA) <input id="outFrom" list="iataList" placeholder="TFN" data-iata="outFromCity"></label>
        <label id="lblOutFromCity">Ciudad origen <input id="outFromCity" placeholder="Tenerife Norte"></label>
        <label id="lblOutTo">Destino (IATA) <input id="outTo" list="iataList" placeholder="MAD" data-iata="outToCity"></label>
        <label id="lblOutToCity">Ciudad destino <input id="outToCity" placeholder="Madrid"></label>
      </div>

      <h2 id="hRet" style="margin-top:12px">Ruta (vuelta)</h2>
      <div class="row">
        <label id="lblRetFrom">Origen (IATA) <input id="retFrom" list="iataList" placeholder="MAD" data-iata="retFromCity"></label>
        <label id="lblRetFromCity">Ciudad origen <input id="retFromCity" placeholder="Madrid"></label>
        <label id="lblRetTo">Destino (IATA) <input id="retTo" list="iataList" placeholder="TFN" data-iata="retToCity"></label>
        <label id="lblRetToCity">Ciudad destino <input id="retToCity" placeholder="Tenerife Norte"></label>
      </div>

      <h2 id="hPrev" style="margin-top:14px">Itinerario anterior</h2>
      <div class="row">
        <label><span id="lblOOAirTxt">Ida — Aerolínea (código)</span> <input id="ooAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label><span id="lblOONumTxt">Ida — N.º vuelo</span> <input id="ooNum" placeholder="3478"></label>
        <label id="lblOODep"><span>Ida — Salida</span> <input id="ooDep" placeholder="10:30"></label>
        <label id="lblOOArr"><span>Ida — Llegada</span> <input id="ooArr" placeholder="12:50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span id="lblORAirTxt">Vuelta — Aerolínea (código)</span> <input id="orAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label><span id="lblORNumTxt">Vuelta — N.º vuelo</span> <input id="orNum" placeholder="3479"></label>
        <label id="lblORDep"><span>Vuelta — Salida</span> <input id="orDep" placeholder="17:20"></label>
        <label id="lblORArr"><span>Vuelta — Llegada</span> <input id="orArr" placeholder="19:35"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span>Ida — Fecha</span> <input id="ooDate" type="date"></label>
        <label><span>Vuelta — Fecha</span> <input id="orDate" type="date"></label>
      </div>

      <h2 id="hNew" style="margin-top:14px">Itinerario nuevo</h2>
      <div class="row">
        <label><span id="lblNOAirTxt">Ida — Aerolínea (código)</span> <input id="noAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label><span id="lblNONumTxt">Ida — N.º vuelo</span> <input id="noNum" placeholder="1234"></label>
        <label id="lblNODep"><span>Ida — Salida</span> <input id="noDep" placeholder="11:15"></label>
        <label id="lblNOArr"><span>Ida — Llegada</span> <input id="noArr" placeholder="13:40"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span id="lblNRAirTxt">Vuelta — Aerolínea (código)</span> <input id="nrAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label><span id="lblNRNumTxt">Vuelta — N.º vuelo</span> <input id="nrNum" placeholder="1235"></label>
        <label id="lblNRDep"><span>Vuelta — Salida</span> <input id="nrDep" placeholder="18:10"></label>
        <label id="lblNRArr"><span>Vuelta — Llegada</span> <input id="nrArr" placeholder="20:30"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span>Ida — Fecha</span> <input id="noDate" type="date"></label>
        <label><span>Vuelta — Fecha</span> <input id="nrDate" type="date"></label>
      </div>

      <h2 id="hCosts" style="margin-top:14px">Costes</h2>
      <div class="row-3">
        <label id="lblPenalty">Penalización <input id="penalty" placeholder="150,00"></label>
        <label id="lblFee">Fee servicio <input id="fee" placeholder="30,00"></label>
        <label id="lblFare">Diferencia de tarifa <input id="fareDiff" placeholder="45,50"></label>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="ncAgree">
          <span class="tiny" id="ncText">Confirmo que este material es informativo y <b>no</b> tiene fines comerciales. Puedes exportar o hacer captura.</span>
        </label>
        <div class="grow"></div>
        <button id="btnPng" class="btn" disabled>Exportar PNG</button>
      </div>

      <details id="adv" style="margin-top:12px">
        <summary id="advSummary">Opciones avanzadas</summary>
        <div class="row" style="margin-top:8px">
          <label id="lblBaseUrl">Logos aerolíneas (base URL) <input id="airlineBase" value=""></label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="fxEnable"> <span id="fxLabel">Convertir desde EUR</span>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>1 EUR = USD <input id="fxUSD" value="1.08"></label>
          <label>1 EUR = MXN <input id="fxMXN" value="19.00"></label>
        </div>
      </details>
    </div>

    <!-- TARJETA (ÁREA A EXPORTAR: incluye itinerarios + precios) -->
    <div class="card" id="cardWrap" style="position:relative">
      <div id="exportArea">
        <div class="band"></div>
        <div class="flex" style="justify-content:space-between;align-items:center;gap:12px">
          <div style="text-align:left">
            <div class="tiny" id="hdr-sub">Cambio de vuelos · Round Trip</div>
            <div style="font:700 22px Poppins" id="hdr-title">Cambio de vuelos</div>
            <div class="tiny" id="hdr-dates">Ida: — → — · Vuelta: — → —</div>
          </div>
          <div class="logoBoxSq"><img id="maarlabLogoM" alt="M" crossorigin="anonymous" referrerpolicy="no-referrer" src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg"></div>
        </div>

        <div class="itins">
          <!-- Anterior -->
          <div class="itinCol itinOld">
            <div style="font:700 14px Poppins" id="prevTitle">Itinerario anterior</div>

            <!-- Old Outbound -->
            <div class="leg">
              <div class="legHead">
                <div class="legRoute">
                  <div class="codes" id="ooCodes">XXX → XXX</div>
                  <div class="tiny" id="ooCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-oo" alt="airline-oo" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta" id="ooMeta">Vuelo — Fecha</div>
              <div class="times" style="margin-top:6px">
                <div><div class="tiny" id="lblDep1">Salida</div><div class="big" id="ooDepLabel">--:--</div></div>
                <div><div class="tiny" id="lblArr1">Llegada</div><div class="big" id="ooArrLabel">--:--</div></div>
              </div>
              <div class="dim" id="ooDur">Duración: —</div>
            </div>

            <!-- Old Return -->
            <div class="leg">
              <div class="legHead">
                <div class="legRoute">
                  <div class="codes" id="orCodes">XXX → XXX</div>
                  <div class="tiny" id="orCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-or" alt="airline-or" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta" id="orMeta">Vuelo — Fecha</div>
              <div class="times" style="margin-top:6px">
                <div><div class="tiny" id="lblDep2">Salida</div><div class="big" id="orDepLabel">--:--</div></div>
                <div><div class="tiny" id="lblArr2">Llegada</div><div class="big" id="orArrLabel">--:--</div></div>
              </div>
              <div class="dim" id="orDur">Duración: —</div>
            </div>
          </div>

          <!-- Nuevo -->
          <div class="itinCol itinNew">
            <div style="font:700 14px Poppins" id="newTitle">Itinerario nuevo</div>

            <!-- New Outbound -->
            <div class="leg">
              <div class="legHead">
                <div class="legRoute">
                  <div class="codes" id="noCodes">XXX → XXX</div>
                  <div class="tiny" id="noCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-no" alt="airline-no" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta" id="noMeta">Vuelo — Fecha</div>
              <div class="times" style="margin-top:6px">
                <div><div class="tiny" id="lblDep3">Salida</div><div class="big" id="noDepLabel">--:--</div></div>
                <div><div class="tiny" id="lblArr3">Llegada</div><div class="big" id="noArrLabel">--:--</div></div>
              </div>
              <div class="dim" id="noDur">Duración: —</div>
              <div class="dim delta" id="noDelta">Cambios: <span class="zero">—</span></div>
            </div>

            <!-- New Return -->
            <div class="leg">
              <div class="legHead">
                <div class="legRoute">
                  <div class="codes" id="nrCodes">XXX → XXX</div>
                  <div class="tiny" id="nrCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-nr" alt="airline-nr" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta" id="nrMeta">Vuelo — Fecha</div>
              <div class="times" style="margin-top:6px">
                <div><div class="tiny" id="lblDep4">Salida</div><div class="big" id="nrDepLabel">--:--</div></div>
                <div><div class="tiny" id="lblArr4">Llegada</div><div class="big" id="nrArrLabel">--:--</div></div>
              </div>
              <div class="dim" id="nrDur">Duración: —</div>
              <div class="dim delta" id="nrDelta">Cambios: <span class="zero">—</span></div>
            </div>
          </div>
        </div>

        <!-- PRECIOS (incluidos en exportación) -->
        <div class="prices" id="pricesBlock">
          <div class="pill"><div class="tiny" id="penLabel">Penalización</div><div class="v" id="penVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="feeLabel">Fee servicio</div><div class="v" id="feeVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="fareLabel">Diferencia de tarifa</div><div class="v" id="fareVal">€0,00</div></div>
          <div class="pill" style="background:#e6f7ff"><div class="tiny" id="totLabel">Total a cobrar</div><div class="v" id="totVal">€0,00</div></div>
        </div>
      </div><!-- /exportArea -->

      <div class="foot">
        <div class="tiny" id="footerText">Generado por Maarlab · Contacto: booking@maarlab.com</div>
      </div>
    </div>
  </div>

<!-- DATALISTS -->
<datalist id="airlineCodes"></datalist>
<datalist id="iataList"></datalist>

<!-- Luxon para TZ -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
const $ = (id)=>document.getElementById(id);

/* ===== i18n ===== */
const STR = {
  es:{docTitle:"Cambio de vuelos · Maarlab",pageTitle:"Cambio de vuelos · Maarlab",
      pageSub:"Itinerario anterior/nuevo · 4 vuelos · EUR/USD/MXN · PNG",
      hdrSub:"Cambio de vuelos · Round Trip",hdrTitle:"Cambio de vuelos",
      outTitle:"Ruta (ida)",retTitle:"Ruta (vuelta)",prev:"Itinerario anterior",next:"Itinerario nuevo",
      dep:"Salida",arr:"Llegada", duration:"Duración", changes:"Cambios",
      acode:"Aerolínea (código)", fnum:"N.º vuelo",
      costs:"Costes", penalty:"Penalización", fee:"Fee servicio", fare:"Diferencia de tarifa", total:"Total a cobrar",
      baseUrl:"Logos aerolíneas (base URL)", adv:"Opciones avanzadas", fx:"Convertir desde EUR",
      nc:"Confirmo que este material es informativo y no tiene fines comerciales. Puedes exportar o hacer captura.",
      footer:"Generado por Maarlab · Contacto: booking@maarlab.com",
      exportWarn:"Debes confirmar uso informativo / no comercial.",
      exportFail:"No se pudo exportar. Se exportará sin logos si el servidor no permite CORS.",
      depDelta:"Δ Salida", arrDelta:"Δ Llegada"},
  en:{docTitle:"Flight change · Maarlab",pageTitle:"Flight change · Maarlab",
      pageSub:"Previous/new itinerary · 4 flights · EUR/USD/MXN · PNG",
      hdrSub:"Flight change · Round Trip",hdrTitle:"Flight change",
      outTitle:"Outbound",retTitle:"Return",prev:"Previous itinerary",next:"New itinerary",
      dep:"Departure",arr:"Arrival", duration:"Duration", changes:"Changes",
      acode:"Airline code", fnum:"Flight no.",
      costs:"Costs", penalty:"Penalty", fee:"Service fee", fare:"Fare difference", total:"Total to charge",
      baseUrl:"Airline logos (base URL)", adv:"Advanced options", fx:"Convert from EUR",
      nc:"I confirm this is informational and non-commercial. You may export or take a screenshot.",
      footer:"Generated by Maarlab · Contact: booking@maarlab.com",
      exportWarn:"Please confirm non-commercial use.",
      exportFail:"Export failed. It will export without logos if the server blocks CORS.",
      depDelta:"Δ Dep", arrDelta:"Δ Arr"}
};
let LANG="es";

/* ===== datos ===== */
const DEFAULT_AIRLINE_BASE = "https://maarlabcdnstorage.blob.core.windows.net/web-assets/images/airlines";
const DEFAULT_MAARLAB_MARK = "https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg";

/* Aerolíneas (ampliado + alias U→U2) */
const AIRLINES = {
  "U":"easyJet","U2":"easyJet",
  "AM":"Aeroméxico","Y4":"Volaris","VB":"VivaAerobus","LA":"LATAM","AR":"Aerolíneas Argentinas","CM":"Copa Airlines",
  "AV":"Avianca","G3":"GOL","H2":"Sky Airline","QP":"Amaszonas","VE":"EasyFly",
  "IB":"Iberia","I2":"Iberia Express","VY":"Vueling","UX":"Air Europa","NT":"Binter Canarias","FR":"Ryanair",
  "W6":"Wizz Air","W4":"Wizz Air Malta","TO":"Transavia France","HV":"Transavia","BA":"British Airways",
  "KL":"KLM","AF":"Air France","LH":"Lufthansa","LX":"SWISS","OS":"Austrian","SN":"Brussels Airlines","LO":"LOT",
  "SK":"SAS","DY":"Norwegian","EW":"Eurowings","A3":"Aegean","OA":"Olympic","TK":"Turkish Airlines","PC":"Pegasus",
  "RO":"TAROM","OU":"Croatia Airlines","JU":"Air Serbia","BT":"airBaltic","AY":"Finnair","OK":"Czech Airlines",
  "RK":"Lauda Europe","X3":"TUIfly","XQ":"SunExpress","QS":"Smartwings","FB":"Bulgaria Air","KM":"Air Malta",
  "QR":"Qatar Airways","EK":"Emirates","EY":"Etihad","RJ":"Royal Jordanian","SV":"Saudia","ME":"MEA","MS":"Egyptair",
  "AA":"American Airlines","UA":"United","DL":"Delta","B6":"JetBlue","WN":"Southwest","NK":"Spirit",
  "F9":"Frontier","AS":"Alaska Airlines","HA":"Hawaiian","AC":"Air Canada","WS":"WestJet","TS":"Air Transat",
  "EI":"Aer Lingus","LS":"Jet2","BE":"Flybe"
};

/* IATA → ciudad */
const IATA_DB = {
  "MAD":"Madrid","BCN":"Barcelona","VLC":"Valencia","AGP":"Málaga","SVQ":"Sevilla","BIO":"Bilbao","PMI":"Palma de Mallorca",
  "IBZ":"Ibiza","ALC":"Alicante","TFN":"Tenerife Norte","TFS":"Tenerife Sur","LPA":"Gran Canaria","ACE":"Lanzarote",
  "FUE":"Fuerteventura","SCQ":"Santiago de Compostela","LCG":"A Coruña","OVD":"Asturias","SDR":"Santander",
  "XRY":"Jerez","GRX":"Granada","LEI":"Almería","VGO":"Vigo","MAH":"Menorca","REU":"Reus",
  "LIS":"Lisboa","OPO":"Oporto","FAO":"Faro","FNC":"Madeira",
  "CDG":"París (CDG)","ORY":"París (Orly)","NCE":"Niza","LYS":"Lyon","MRS":"Marsella","BRU":"Bruselas",
  "AMS":"Ámsterdam","EIN":"Eindhoven","RTM":"Róterdam",
  "FRA":"Fráncfort","MUC":"Múnich","BER":"Berlín","DUS":"Düsseldorf","HAM":"Hamburgo","STR":"Stuttgart","CGN":"Colonia/Bonn",
  "VIE":"Viena","ZRH":"Zúrich","GVA":"Ginebra","BSL":"Basilea",
  "FCO":"Roma (Fiumicino)","CIA":"Roma (Ciampino)","MXP":"Milán (Malpensa)","LIN":"Milán (Linate)","BGY":"Bérgamo",
  "NAP":"Nápoles","VCE":"Venecia","FLR":"Florencia","CTA":"Catania","PMO":"Palermo",
  "LHR":"Londres (Heathrow)","LGW":"Londres (Gatwick)","LTN":"Londres (Luton)","STN":"Londres (Stansted)","LCY":"Londres (City)",
  "MAN":"Mánchester","BHX":"Birmingham","EDI":"Edimburgo","GLA":"Glasgow","ABZ":"Aberdeen","NCL":"Newcastle",
  "LPL":"Liverpool","LBA":"Leeds Bradford","EMA":"East Midlands","BRS":"Bristol","EXT":"Exeter","SOU":"Southampton",
  "CWL":"Cardiff","BFS":"Belfast (Intl)","BHD":"Belfast (City)","JER":"Jersey","GCI":"Guernsey","NQY":"Newquay",
  "DUB":"Dublín","SNN":"Shannon","ORK":"Cork",
  "CPH":"Copenhague","OSL":"Oslo","ARN":"Estocolmo","HEL":"Helsinki","RIX":"Riga","TLL":"Tallin","VNO":"Vilna",
  "WAW":"Varsovia","KRK":"Cracovia","PRG":"Praga","BUD":"Budapest","OTP":"Bucarest","SOF":"Sofía","BEG":"Belgrado",
  "ZAG":"Zagreb","SPU":"Split","DBV":"Dubrovnik","ATH":"Atenas","SKG":"Tesalónica","LCA":"Lárnaca","MLA":"La Valeta",
  "KEF":"Reikiavik",
  "IST":"Estambul","SAW":"Estambul (SAW)","AYT":"Antalya","ADB":"Esmirna","CMN":"Casablanca","RAK":"Marrakech","TUN":"Túnez","CAI":"El Cairo",
  "MEX":"Ciudad de México","GDL":"Guadalajara","MTY":"Monterrey","CUN":"Cancún","PVR":"Puerto Vallarta","SJD":"Los Cabos",
  "CZM":"Cozumel","MID":"Mérida","HMO":"Hermosillo","TIJ":"Tijuana","CUL":"Culiacán","LAP":"La Paz","LTO":"Loreto",
  "MZT":"Mazatlán","VER":"Veracruz","TAM":"Tampico","TAP":"Tapachula","TGZ":"Tuxtla Gutiérrez","OAX":"Oaxaca","HUX":"Huatulco",
  "PXM":"Puerto Escondido","PBC":"Puebla","QRO":"Querétaro","BJX":"León/Del Bajío","ZIH":"Ixtapa-Zihuatanejo","ZLO":"Manzanillo",
  "CEN":"Ciudad Obregón","CUU":"Chihuahua","CJS":"Ciudad Juárez","REX":"Reynosa","NLD":"Nuevo Laredo","SLW":"Saltillo",
  "MXL":"Mexicali","CPE":"Campeche","VSA":"Villahermosa","ACA":"Acapulco","TQO":"Tulum (Felipe Carrillo Puerto)",
  "ATL":"Atlanta","JFK":"Nueva York (JFK)","LGA":"Nueva York (LaGuardia)","EWR":"Newark",
  "BOS":"Boston","PHL":"Filadelfia","IAD":"Washington Dulles","DCA":"Washington National","BWI":"Baltimore",
  "MIA":"Miami","FLL":"Fort Lauderdale","PBI":"West Palm Beach","MCO":"Orlando","TPA":"Tampa","RSW":"Fort Myers","JAX":"Jacksonville",
  "ORD":"Chicago O'Hare","MDW":"Chicago Midway","MSP":"Minneapolis","DTW":"Detroit","CLE":"Cleveland","CMH":"Columbus","IND":"Indianápolis",
  "MKE":"Milwaukee","STL":"St. Louis","DFW":"Dallas/Fort Worth","DAL":"Dallas Love","IAH":"Houston Intercontinental",
  "HOU":"Houston Hobby","AUS":"Austin","SAT":"San Antonio","DEN":"Denver","PHX":"Phoenix","LAS":"Las Vegas","SLC":"Salt Lake City",
  "SEA":"Seattle","PDX":"Portland","GEG":"Spokane","BOI":"Boise","SFO":"San Francisco","OAK":"Oakland","SJC":"San José",
  "LAX":"Los Ángeles","BUR":"Burbank","SNA":"Santa Ana/Orange Co","ONT":"Ontario (CA)","SAN":"San Diego","SMF":"Sacramento","RNO":"Reno",
  "ABQ":"Albuquerque","ELP":"El Paso","OKC":"Oklahoma City","TUL":"Tulsa","MCI":"Kansas City","OMA":"Omaha","BNA":"Nashville","MEM":"Memphis",
  "CLT":"Charlotte","RDU":"Raleigh/Durham","GSO":"Greensboro","CHS":"Charleston","SAV":"Savannah","RIC":"Richmond","ORF":"Norfolk",
  "BUF":"Búfalo","ROC":"Rochester (NY)","SYR":"Syracuse","ALB":"Albany","BDL":"Hartford","PVD":"Providence","BTV":"Burlington",
  "PWM":"Portland (ME)","HNL":"Honolulu","OGG":"Kahului (Maui)","LIH":"Lihue (Kauai)","KOA":"Kona","ANC":"Anchorage"
};

/* IATA → Zona horaria IANA (principalmente por país/región) */
const TZ_DB = {
  // España
  "MAD":"Europe/Madrid","BCN":"Europe/Madrid","VLC":"Europe/Madrid","AGP":"Europe/Madrid","SVQ":"Europe/Madrid","BIO":"Europe/Madrid","PMI":"Europe/Madrid",
  "IBZ":"Europe/Madrid","ALC":"Europe/Madrid","TFN":"Atlantic/Canary","TFS":"Atlantic/Canary","LPA":"Atlantic/Canary","ACE":"Atlantic/Canary","FUE":"Atlantic/Canary",
  "SCQ":"Europe/Madrid","LCG":"Europe/Madrid","OVD":"Europe/Madrid","SDR":"Europe/Madrid","XRY":"Europe/Madrid","GRX":"Europe/Madrid","LEI":"Europe/Madrid",
  "VGO":"Europe/Madrid","MAH":"Europe/Madrid","REU":"Europe/Madrid",
  // Portugal
  "LIS":"Europe/Lisbon","OPO":"Europe/Lisbon","FAO":"Europe/Lisbon","FNC":"Atlantic/Madeira",
  // Francia/BeNeLux/NL
  "CDG":"Europe/Paris","ORY":"Europe/Paris","NCE":"Europe/Paris","LYS":"Europe/Paris","MRS":"Europe/Paris","BRU":"Europe/Brussels",
  "AMS":"Europe/Amsterdam","EIN":"Europe/Amsterdam","RTM":"Europe/Amsterdam",
  // D/A/CH
  "FRA":"Europe/Berlin","MUC":"Europe/Berlin","BER":"Europe/Berlin","DUS":"Europe/Berlin","HAM":"Europe/Berlin","STR":"Europe/Berlin","CGN":"Europe/Berlin",
  "VIE":"Europe/Vienna","ZRH":"Europe/Zurich","GVA":"Europe/Zurich","BSL":"Europe/Zurich",
  // Italia
  "FCO":"Europe/Rome","CIA":"Europe/Rome","MXP":"Europe/Rome","LIN":"Europe/Rome","BGY":"Europe/Rome","NAP":"Europe/Rome","VCE":"Europe/Rome","FLR":"Europe/Rome","CTA":"Europe/Rome","PMO":"Europe/Rome",
  // UK / IE
  "LHR":"Europe/London","LGW":"Europe/London","LTN":"Europe/London","STN":"Europe/London","LCY":"Europe/London","MAN":"Europe/London","BHX":"Europe/London",
  "EDI":"Europe/London","GLA":"Europe/London","ABZ":"Europe/London","NCL":"Europe/London","LPL":"Europe/London","LBA":"Europe/London","EMA":"Europe/London",
  "BRS":"Europe/London","EXT":"Europe/London","SOU":"Europe/London","CWL":"Europe/London","BFS":"Europe/London","BHD":"Europe/London",
  "JER":"Europe/Jersey","GCI":"Europe/Guernsey","NQY":"Europe/London","DUB":"Europe/Dublin","SNN":"Europe/Dublin","ORK":"Europe/Dublin",
  // Norte/Este
  "CPH":"Europe/Copenhagen","OSL":"Europe/Oslo","ARN":"Europe/Stockholm","HEL":"Europe/Helsinki","RIX":"Europe/Riga","TLL":"Europe/Tallinn","VNO":"Europe/Vilnius",
  "WAW":"Europe/Warsaw","KRK":"Europe/Warsaw","PRG":"Europe/Prague","BUD":"Europe/Budapest","OTP":"Europe/Bucharest","SOF":"Europe/Sofia","BEG":"Europe/Belgrade",
  "ZAG":"Europe/Zagreb","SPU":"Europe/Zagreb","DBV":"Europe/Zagreb","ATH":"Europe/Athens","SKG":"Europe/Athens","LCA":"Asia/Nicosia","MLA":"Europe/Malta",
  "KEF":"Atlantic/Reykjavik",
  // Turquía / MENA
  "IST":"Europe/Istanbul","SAW":"Europe/Istanbul","AYT":"Europe/Istanbul","ADB":"Europe/Istanbul","CMN":"Africa/Casablanca",
  "RAK":"Africa/Casablanca","TUN":"Africa/Tunis","CAI":"Africa/Cairo",
  // México
  "MEX":"America/Mexico_City","GDL":"America/Mexico_City","MTY":"America/Monterrey","CUN":"America/Cancun","TQO":"America/Cancun",
  "CZM":"America/Cancun","PVR":"America/Mexico_City","SJD":"America/Mazatlan","HMO":"America/Hermosillo","TIJ":"America/Tijuana",
  "CUL":"America/Mazatlan","LAP":"America/Mazatlan","LTO":"America/Mazatlan","MZT":"America/Mazatlan","VER":"America/Mexico_City",
  "TAM":"America/Mexico_City","TAP":"America/Mexico_City","TGZ":"America/Mexico_City","OAX":"America/Mexico_City","HUX":"America/Mexico_City",
  "PXM":"America/Mexico_City","PBC":"America/Mexico_City","QRO":"America/Mexico_City","BJX":"America/Mexico_City",
  "ZIH":"America/Mexico_City","ZLO":"America/Mexico_City","CEN":"America/Hermosillo","CUU":"America/Chihuahua","CJS":"America/Ojinaga",
  "REX":"America/Matamoros","NLD":"America/Matamoros","SLW":"America/Monterrey","MXL":"America/Tijuana","CPE":"America/Merida","VSA":"America/Mexico_City","ACA":"America/Mexico_City",
  // USA
  "ATL":"America/New_York","JFK":"America/New_York","LGA":"America/New_York","EWR":"America/New_York","BOS":"America/New_York","PHL":"America/New_York",
  "IAD":"America/New_York","DCA":"America/New_York","BWI":"America/New_York","MIA":"America/New_York","FLL":"America/New_York","PBI":"America/New_York",
  "MCO":"America/New_York","TPA":"America/New_York","RSW":"America/New_York","JAX":"America/New_York","ORD":"America/Chicago","MDW":"America/Chicago",
  "MSP":"America/Chicago","DTW":"America/Detroit","CLE":"America/New_York","CMH":"America/New_York","IND":"America/Indiana/Indianapolis",
  "MKE":"America/Chicago","STL":"America/Chicago","DFW":"America/Chicago","DAL":"America/Chicago","IAH":"America/Chicago","HOU":"America/Chicago",
  "AUS":"America/Chicago","SAT":"America/Chicago","DEN":"America/Denver","PHX":"America/Phoenix","LAS":"America/Los_Angeles","SLC":"America/Denver",
  "SEA":"America/Los_Angeles","PDX":"America/Los_Angeles","GEG":"America/Los_Angeles","BOI":"America/Boise","SFO":"America/Los_Angeles","OAK":"America/Los_Angeles",
  "SJC":"America/Los_Angeles","LAX":"America/Los_Angeles","BUR":"America/Los_Angeles","SNA":"America/Los_Angeles","ONT":"America/Los_Angeles",
  "SAN":"America/Los_Angeles","SMF":"America/Los_Angeles","RNO":"America/Los_Angeles","ABQ":"America/Denver","ELP":"America/Denver",
  "OKC":"America/Chicago","TUL":"America/Chicago","MCI":"America/Chicago","OMA":"America/Chicago","BNA":"America/Chicago","MEM":"America/Chicago",
  "CLT":"America/New_York","RDU":"America/New_York","GSO":"America/New_York","CHS":"America/New_York","SAV":"America/New_York",
  "RIC":"America/New_York","ORF":"America/New_York","BUF":"America/New_York","ROC":"America/New_York","SYR":"America/New_York","ALB":"America/New_York",
  "BDL":"America/New_York","PVD":"America/New_York","BTV":"America/New_York","PWM":"America/New_York","HNL":"Pacific/Honolulu",
  "OGG":"Pacific/Honolulu","LIH":"Pacific/Honolulu","KOA":"Pacific/Honolulu","ANC":"America/Anchorage"
};

/* ===== estado/helpers ===== */
let CUR="EUR";
let fmt = new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2});
const nf = (cur,lang)=>new Intl.NumberFormat(lang==="en"?"en-US":"es-ES",{style:"currency",currency:cur,minimumFractionDigits:2,maximumFractionDigits:2});
const parseMoney = s => { const t=String(s||"").replace(/\./g,"").replace(",","."); const n=parseFloat(t); return isFinite(n)?n:0; };
const normalizeLogoCode = c => (c==="U"?"U2":(c||"").toUpperCase());
const airlineLogo = code => ( ($("airlineBase")?.value || DEFAULT_AIRLINE_BASE).replace(/\/$/,"") + "/" + normalizeLogoCode(code) + ".png" );
const fmtDate = (val)=>{ if(!val) return "—"; const [y,m,d]=String(val).split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:val; };
const flightStr = (code,num)=>{ const cc=(code||"").toUpperCase(); const nn=(num||"").toUpperCase(); return (cc||nn)?`${cc}${nn}`:"—"; };

const HM_RE = /^([01]\d|2[0-3]):[0-5]\d$/;

/* Duración real con TZ (Luxon) */
const { DateTime } = luxon;
function zonedDT(dateISO, hm, iata){
  if(!dateISO || !HM_RE.test(hm) || !iata) return null;
  const z = TZ_DB[iata.toUpperCase()] || "UTC";
  // compone YYYY-MM-DDTHH:MM en zona del aeropuerto
  return DateTime.fromISO(`${dateISO}T${hm}`, { zone: z });
}
function legDurationM(dateISO, depHM, arrHM, fromIata, toIata){
  const dep = zonedDT(dateISO, depHM, fromIata);
  const arrSame = zonedDT(dateISO, arrHM, toIata);
  if(!dep || !arrSame) return NaN;
  // compara en UTC; si negativo, asume llegada día siguiente (+24h) hasta ser positivo
  let diff = arrSame.toUTC().diff(dep.toUTC(), "minutes").minutes;
  while(diff < 0) diff += 1440;
  return diff;
}
const fmtH = (m)=> isFinite(m)?(`${Math.floor(Math.abs(m)/60)}h ${Math.abs(m)%60}m`):"—";
const fmtSigned = (m)=> !isFinite(m)?"—":((m===0)?"±0m":((m>0?"+":"-")+`${Math.floor(Math.abs(m)/60)}h ${Math.abs(m)%60}m`));

function moneyOut(v){
  if(CUR==="EUR") return fmt.format(v);
  const fx = $("fxEnable")?.checked;
  if(!fx) return nf(CUR,LANG).format(v);
  const usd = Number($("fxUSD").value||1.08);
  const mxn = Number($("fxMXN").value||19.0);
  if(CUR==="USD") return nf("USD",LANG).format(v*usd);
  if(CUR==="MXN") return nf("MXN",LANG).format(v*mxn);
  return nf(CUR,LANG).format(v);
}

/* ===== i18n apply ===== */
function applyI18n(){
  const S=STR[LANG];
  document.title = S.docTitle;
  $("pageTitle").textContent = S.pageTitle;
  $("pageSubtitle").textContent = S.pageSub;
  $("hdr-sub").textContent = S.hdrSub;
  $("hdr-title").textContent = S.hdrTitle;
  $("hOut").textContent = S.outTitle; $("hRet").textContent=S.retTitle;
  $("prevTitle").textContent=S.prev; $("newTitle").textContent=S.next;
  ["lblDep1","lblDep2","lblDep3","lblDep4"].forEach(id=>$(id).textContent=S.dep);
  ["lblArr1","lblArr2","lblArr3","lblArr4"].forEach(id=>$(id).textContent=S.arr);
  $("hCosts").textContent=S.costs; $("penLabel").textContent=S.penalty; $("feeLabel").textContent=S.fee;
  $("fareLabel").textContent=S.fare; $("totLabel").textContent=S.total;
  $("advSummary").textContent=S.adv; $("lblBaseUrl").childNodes[0].textContent=S.baseUrl+" ";
  $("fxLabel").textContent=S.fx; $("ncText").textContent=S.nc; $("footerText").textContent=S.footer;

  $("lblOOAirTxt").textContent = `${LANG==="es"?"Ida —": "Out —"} ${S.acode}`;
  $("lblOONumTxt").textContent = `${LANG==="es"?"Ida —": "Out —"} ${S.fnum}`;
  $("lblORAirTxt").textContent = `${LANG==="es"?"Vuelta —": "Return —"} ${S.acode}`;
  $("lblORNumTxt").textContent = `${LANG==="es"?"Vuelta —": "Return —"} ${S.fnum}`;
  $("lblNOAirTxt").textContent = `${LANG==="es"?"Ida —": "Out —"} ${S.acode}`;
  $("lblNONumTxt").textContent = `${LANG==="es"?"Ida —": "Out —"} ${S.fnum}`;
  $("lblNRAirTxt").textContent = `${LANG==="es"?"Vuelta —": "Return —"} ${S.acode}`;
  $("lblNRNumTxt").textContent = `${LANG==="es"?"Vuelta —": "Return —"} ${S.fnum}`;

  fmt = nf(CUR,LANG);
  refresh();
}

/* ===== binds ===== */
function bindAll(){
  document.querySelectorAll("#panel input, #panel select").forEach(el=>{
    el.addEventListener("input", (e)=>{
      if(/(Air|outFrom|outTo|retFrom|retTo)$/i.test(e.target.id)){ e.target.value = e.target.value.toUpperCase(); }
      if(/(Dep|Arr)$/i.test(e.target.id)){
        e.target.classList.toggle("invalid", !HM_RE.test(e.target.value));
      }
      refresh();
    });
    el.addEventListener("change", refresh);
  });
  document.querySelectorAll('input[data-iata]').forEach(inp=>{
    inp.addEventListener('input', ()=>{ const city=$(inp.dataset.iata); const c=(inp.value||"").toUpperCase().trim(); if(city && c.length>=3 && IATA_DB[c]) city.value=IATA_DB[c]; refresh(); });
    inp.addEventListener('blur',  ()=>{ const city=$(inp.dataset.iata); const c=(inp.value||"").toUpperCase().trim(); if(city && IATA_DB[c]) city.value=IATA_DB[c]; refresh(); });
  });
  $("chipCurrency")?.addEventListener("click",(e)=>{ const b=e.target.closest("button"); if(!b) return; CUR=b.dataset.cur; document.querySelectorAll("#chipCurrency button").forEach(x=>x.classList.toggle("active",x===b)); fmt=nf(CUR,LANG); refresh(); });
  $("chipLang")?.addEventListener("click",(e)=>{ const b=e.target.closest("button"); if(!b) return; LANG=b.dataset.lang; document.querySelectorAll("#chipLang button").forEach(x=>x.classList.toggle("active",x===b)); applyI18n(); });
  $("ncAgree")?.addEventListener("change", ()=>{ $("btnPng").disabled=!$("ncAgree").checked; });
  $("btnPng")?.addEventListener("click", exportPNG);

  $("airlineBase").value ||= DEFAULT_AIRLINE_BASE;
  $("maarlabLogoM").src ||= DEFAULT_MAARLAB_MARK;

  const dlAir = $("airlineCodes"); dlAir.innerHTML="";
  Object.keys(AIRLINES).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.label=AIRLINES[k]; dlAir.appendChild(o); });
  const dlIata = $("iataList"); dlIata.innerHTML="";
  Object.keys(IATA_DB).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.label=IATA_DB[k]; dlIata.appendChild(o); });
}

/* ===== render ===== */
function setLegLogo(imgId, code){
  const img=$(imgId); if(!img) return;
  const c = normalizeLogoCode(code);
  if(c){ img.src=airlineLogo(c); img.style.visibility="visible";
    img.onerror=()=>{img.style.visibility="hidden"; img.removeAttribute("src");};
    img.crossOrigin="anonymous"; img.referrerPolicy="no-referrer";
  } else { img.style.visibility="hidden"; img.removeAttribute("src"); }
}

function deltaSpan(label, mins){
  const span = document.createElement("span");
  if(!isFinite(mins)){ span.className="zero"; span.textContent=`${label}: —`; return span; }
  if(mins===0){ span.className="zero"; span.textContent=`${label}: ±0m`; return span; }
  span.className = mins>0 ? "pos" : "neg";
  span.textContent = `${label}: ${fmtSigned(mins)}`;
  return span;
}

function refresh(){
  const outFrom=$("outFrom").value||"XXX", outTo=$("outTo").value||"XXX";
  const retFrom=$("retFrom").value||"XXX", retTo=$("retTo").value||"XXX";
  const outFromCity=$("outFromCity").value||"—", outToCity=$("outToCity").value||"—";
  const retFromCity=$("retFromCity").value||"—", retToCity=$("retToCity").value||"—";

  // Fechas DD/MM/AAAA
  const ood=fmtDate($("ooDate").value), ord=fmtDate($("orDate").value), nod=fmtDate($("noDate").value), nrd=fmtDate($("nrDate").value);
  $("hdr-dates").textContent = `${LANG==="es"?"Ida":"Out"}: ${ood} → ${nod} · ${LANG==="es"?"Vuelta":"Return"}: ${ord} → ${nrd}`;

  // códigos + números
  const ooC=($("ooAir").value||"").toUpperCase(), orC=($("orAir").value||"").toUpperCase();
  const noC=($("noAir").value||"").toUpperCase(), nrC=($("nrAir").value||"").toUpperCase();
  const ooN=($("ooNum").value||"").toUpperCase(), orN=($("orNum").value||"").toUpperCase();
  const noN=($("noNum").value||"").toUpperCase(), nrN=($("nrNum").value||"").toUpperCase();

  // rutas
  $("ooCodes").textContent=`${outFrom} → ${outTo}`;  $("noCodes").textContent=`${outFrom} → ${outTo}`;
  $("orCodes").textContent=`${retFrom} → ${retTo}`;  $("nrCodes").textContent=`${retFrom} → ${retTo}`;
  $("ooCities").textContent=`${outFromCity} → ${outToCity}`; $("noCities").textContent=`${outFromCity} → ${outToCity}`;
  $("orCities").textContent=`${retFromCity} → ${retToCity}`; $("nrCities").textContent=`${retFromCity} → ${retToCity}`;

  // metas (vuelo + aerolínea + fecha)
  $("ooMeta").textContent = `${flightStr(ooC,ooN)} · ${(AIRLINES[normalizeLogoCode(ooC)]||"—")} · ${ood}`;
  $("orMeta").textContent = `${flightStr(orC,orN)} · ${(AIRLINES[normalizeLogoCode(orC)]||"—")} · ${ord}`;
  $("noMeta").textContent = `${flightStr(noC,noN)} · ${(AIRLINES[normalizeLogoCode(noC)]||"—")} · ${nod}`;
  $("nrMeta").textContent = `${flightStr(nrC,nrN)} · ${(AIRLINES[normalizeLogoCode(nrC)]||"—")} · ${nrd}`;

  // logos
  setLegLogo("logo-oo", ooC); setLegLogo("logo-or", orC); setLegLogo("logo-no", noC); setLegLogo("logo-nr", nrC);

  // horas + validación (duración real con TZ)
  const oodm = legDurationM($("ooDate").value, $("ooDep").value, $("ooArr").value, outFrom, outTo);
  const ordm = legDurationM($("orDate").value, $("orDep").value, $("orArr").value, retFrom, retTo);
  const nodm = legDurationM($("noDate").value, $("noDep").value, $("noArr").value, outFrom, outTo);
  const nrdm = legDurationM($("nrDate").value, $("nrDep").value, $("nrArr").value, retFrom, retTo);

  $("ooDepLabel").textContent=$("ooDep").value||"--:--"; $("ooArrLabel").textContent=$("ooArr").value||"--:--";
  $("orDepLabel").textContent=$("orDep").value||"--:--"; $("orArrLabel").textContent=$("orArr").value||"--:--";
  $("noDepLabel").textContent=$("noDep").value||"--:--"; $("noArrLabel").textContent=$("noArr").value||"--:--";
  $("nrDepLabel").textContent=$("nrDep").value||"--:--"; $("nrArrLabel").textContent=$("nrArr").value||"--:--";

  $("ooDur").textContent = `${STR[LANG].duration}: ${fmtH(oodm)}`;
  $("orDur").textContent = `${STR[LANG].duration}: ${fmtH(ordm)}`;
  $("noDur").textContent = `${STR[LANG].duration}: ${fmtH(nodm)}`;
  $("nrDur").textContent = `${STR[LANG].duration}: ${fmtH(nrdm)}`;

  // Deltas horario (local vs local anterior)
  const tMin = (hm)=> HM_RE.test(hm) ? (parseInt(hm.slice(0,2),10)*60 + parseInt(hm.slice(3),10)) : NaN;
  function norm(m){ if(!isFinite(m)) return NaN; if(m>720) m-=1440; if(m<-720) m+=1440; return m; }
  const nDepOut = norm(tMin($("noDep").value)-tMin($("ooDep").value));
  const nArrOut = norm(tMin($("noArr").value)-tMin($("ooArr").value));
  const nDepRet = norm(tMin($("nrDep").value)-tMin($("orDep").value));
  const nArrRet = norm(tMin($("nrArr").value)-tMin($("orArr").value));

  const noDelta = $("noDelta"); noDelta.textContent = STR[LANG].changes + ": ";
  noDelta.appendChild(deltaSpan(STR[LANG].depDelta, nDepOut)); noDelta.append(" · ");
  noDelta.appendChild(deltaSpan(STR[LANG].arrDelta, nArrOut));

  const nrDelta = $("nrDelta"); nrDelta.textContent = STR[LANG].changes + ": ";
  nrDelta.appendChild(deltaSpan(STR[LANG].depDelta, nDepRet)); nrDelta.append(" · ");
  nrDelta.appendChild(deltaSpan(STR[LANG].arrDelta, nArrRet));

  // precios
  const p=parseMoney($("penalty").value), f=parseMoney($("fee").value), d=parseMoney($("fareDiff").value);
  $("penVal").textContent=moneyOut(p);
  $("feeVal").textContent=moneyOut(f);
  $("fareVal").textContent=moneyOut(d);
  $("totVal").textContent=moneyOut(p+f+d);
}

/* ===== incrustar logos para evitar CORS (si falla, oculta logos y exporta igual) ===== */
async function inlineImgs(root){
  const imgs = Array.from(root.querySelectorAll("img"));
  const originals = [];
  for(const img of imgs){
    if(!img.src || img.src.startsWith("data:")) continue;
    originals.push([img, img.src, img.style.visibility]);
    try{
      const res = await fetch(img.src, {mode:"cors", cache:"no-store"});
      if(!res.ok) throw new Error("fetch " + res.status);
      const blob = await res.blob();
      const reader = new FileReader();
      const dataUrl = await new Promise(r=>{ reader.onload=()=>r(reader.result); reader.readAsDataURL(blob); });
      img.setAttribute("data-inline-src", img.src);
      img.src = dataUrl;
    }catch(e){
      // si no se puede, esconder para no taint el canvas
      img.setAttribute("data-inline-failed","1");
      img.style.visibility="hidden";
    }
  }
  return ()=>{ // restore
    for(const [img, src, vis] of originals){
      if(img.getAttribute("data-inline-src")) img.src = src;
      img.style.visibility = vis || "";
      img.removeAttribute("data-inline-src");
      img.removeAttribute("data-inline-failed");
    }
  };
}

/* ===== export (incluye itinerarios + precios) ===== */
async function exportPNG(){
  if(!$("ncAgree").checked){ alert(STR[LANG].exportWarn); return; }
  try{
    const restore = await inlineImgs($("exportArea"));
    const dataUrl = await htmlToImage.toPng($("exportArea"), {pixelRatio:2, cacheBust:true});
    restore();
    const out=$("outFrom").value||"XXX", to=$("outTo").value||"XXX", r1=$("retFrom").value||"XXX", r2=$("retTo").value||"XXX";
    const when = $("nrDate").value || $("noDate").value || $("orDate").value || $("ooDate").value || "date";
    const a=document.createElement("a"); a.href=dataUrl; a.download=`${out}-${to}_${r1}-${r2}-${when}.png`.replace(/\s+/g,"_"); a.click();
  }catch(e){
    alert(STR[LANG].exportFail);
    console.error(e);
  }
}

/* start */
(function start(){
  $("airlineBase").value = $("airlineBase").value || DEFAULT_AIRLINE_BASE;
  bindAll();
  // datalist inicial
  const dlAir = $("airlineCodes"); Object.keys(AIRLINES).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.label=AIRLINES[k]; dlAir.appendChild(o); });
  const dlIata = $("iataList"); Object.keys(IATA_DB).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.label=IATA_DB[k]; dlIata.appendChild(o); });
  applyI18n(); // llama a refresh
})();
</script>
</body>
</html>
