<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizador de cambios · Maarlab</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --card:#fff; --ink:#0b2a5a; --sub:#475569; --border:#d7ddea;
    --accent:#15c79b; --accent2:#2ca9ff;
    --oldA:#ffc7d0; --oldB:#ff9aa9; --oldBorder:#7f1d1d;
    --newA:#cfeedd; --newB:#aee6c8; --newBorder:#14532d;
    --muted:#eef2f7;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:15px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui,sans-serif;
    background:#0a223f;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  body::after{content:"";position:fixed;inset:0;z-index:-1;background:linear-gradient(to bottom,rgba(255,255,255,.14),rgba(255,255,255,.22) 45%,rgba(255,255,255,.70))}
  .wrap{max-width:1240px;margin:0 auto;padding:16px}
  .bar{position:sticky;top:0;background:#ffffff;border-bottom:1px solid var(--border);z-index:30}
  .barInner{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1240px;margin:0 auto;padding:10px 16px}
  .brandTitle{font:700 18px/1 Poppins,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui;letter-spacing:.2px}
  .sep{height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .logoBoxTiny{width:28px;height:28px;border:1px solid var(--border);border-radius:8px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoBoxTiny img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .grid2{display:grid;gap:16px}
  @media(min-width:1100px){.grid2{grid-template-columns:2fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px}
  .btn{border:0;border-radius:12px;padding:10px 14px;color:#0b2a5a;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;font-weight:600}
  .chip{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .chip button{padding:6px 10px;border:0;background:#f1f5f9;cursor:pointer;color:#0b2a5a}
  .chip button.active{background:#fff}
  label{font-size:12px;color:#334155;display:block;margin-bottom:8px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#0b2a5a}
  input[placeholder]{text-transform:uppercase}
  input.invalid{border-color:#ef4444!important;background:#fff1f2}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .tiny{font-size:11px;color:#64748b}
  h2{font:700 16px/1.2 Poppins,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui;margin:0 0 6px}
  #exportArea{position:relative}
  .wm{position:absolute;inset:0;pointer-events:none;display:none}
  .wm.show::before{
    content:attr(data-text);position:absolute;top:50%;left:50%;
    transform:translate(-50%,-50%) rotate(-16deg);
    font:700 64px/1 Poppins,system-ui;color:#0b2a5a;opacity:.08;white-space:nowrap
  }
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px}
  #hdr-title{font:700 32px/1.1 Poppins,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui}
  .logoCard{width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoCard img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .itins{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .itinCol{border:1px solid var(--border);border-radius:14px;padding:12px;min-height:300px}
  .itinOld{background:linear-gradient(180deg,var(--oldA),var(--oldB));border-color:var(--oldBorder)}
  .itinNew{background:linear-gradient(180deg,var(--newA),var(--newB));border-color:var(--newBorder)}
  .leg{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8;margin-top:10px}
  .legHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .codes{font-weight:700;font-size:18px}
  .airLogoBox{height:42px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;min-width:120px}
  .airLogoBox img{max-height:100%;width:auto;display:block}
  .meta{font-size:12px;color:#475569;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:3px 8px;font-size:11px;color:#334155}
  #locBadges .badge{font-size:13px;padding:5px 10px}
  .times{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .times.stop{grid-template-columns:repeat(4,1fr)}
  .big{font-weight:700;font-size:18px}
  .dim{font-size:12px;color:#334155;margin-top:6px}
  .prices{display:grid;grid-template-columns:repeat(4,1fr) 1.2fr;gap:12px;margin-top:14px}
  .pill{border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;background:var(--muted)}
  .pill .v{font-weight:700}
  .totalPill{background:linear-gradient(135deg,#e7f3ff,#ecfbff);border-color:#93c5fd}
  .totalPill .v{font-size:22px}
  .notes{margin-top:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px;min-height:60px}
  .foot{display:flex;justify-content:space-between;gap:12px;margin-top:12px;color:#64748b;font-size:12px;align-items:center}
  .hotelBox{display:none;align-items:center;justify-content:space-between;gap:10px;margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8}
  .hotelLogo{width:56px;height:56px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .hotelLogo img{max-width:100%;max-height:100%;object-fit:contain}
  @media print{
    .bar,.sep,#panel,.btnPdfHide{display:none!important}
    *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
    @page{size:A4 landscape;margin:8mm}
    html,body{height:auto}
    .wrap{padding:0}
    body{font-size:12px}
    #hdr-title{font-size:26px}
    .codes{font-size:16px}
    .big{font-size:16px}
    .logoCard{width:28px;height:28px}
    .notes{min-height:40px}
    #exportArea{transform:scale(0.92);transform-origin:top left}
  }
  #err{display:none;background:#fff4f4;border:1px solid #fecaca;color:#7f1d1d;padding:8px;border-radius:10px;margin:10px 0;font-size:13px}
</style>
</head>
<body>
  <!-- ... tu estructura HTML de la tarjeta + formulario, igual que antes ... -->
  <!-- (no lo repito aquí por espacio, pero va intacto) -->

  <datalist id="airlineCodes"></datalist>
  <datalist id="iataList"></datalist>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script>
(function(){
  var $ = id => document.getElementById(id);

  /* ===== i18n y AIRLINES ===== */
  var STR = { /* ...igual que antes... */ };
  var W   = { /* ...igual que antes... */ };
  var AIRLINES = { /* ...igual que antes... */ };
  var LOGO_FALLBACK = {"F8":"F9","U":"U2"};

  var LANG="es", CUR="EUR", MODE="quote";
  var DateTime = luxon.DateTime;
  var hotelLogoData = "";

  /* ===== Aeropuertos desde JSON ===== */
  var IATA_DB = {};
  var TZ_DB   = {};

  async function loadAirports(){
    try{
      const r = await fetch('main/airports.json', { cache:'no-store' });
      const data = await r.json();
      if (data.IATA_DB && data.TZ_DB){
        IATA_DB = data.IATA_DB;
        TZ_DB   = data.TZ_DB;
      } else {
        Object.keys(data||{}).forEach(k=>{
          if(data[k].city) IATA_DB[k] = data[k].city;
          if(data[k].tz)   TZ_DB[k]   = data[k].tz;
        });
      }
      const dlI = $('iataList');
      if(dlI){
        dlI.innerHTML='';
        Object.keys(IATA_DB).sort().forEach(k=>{
          const o=document.createElement('option');
          o.value=k; o.label=IATA_DB[k];
          dlI.appendChild(o);
        });
      }
    }catch(e){
      console.warn("No se pudo cargar airports.json", e);
    }
  }

  /* ===== Resto de funciones (nf, parseMoney, normalizeCode, airlineLogoUrl, 
           fmtDate, dayOfWeek, zonedDT, segmentMinutes, layoverMinutes, fmtHM,
           moneyOut, applyI18n, buildBadges, setLegLogo, renderLeg, refresh, bindAll) 
           van tal cual como los tenías ===== */

  document.addEventListener("DOMContentLoaded", async function(){
    try{
      await loadAirports();
      bindAll();
      applyI18n();
      refresh();
    }catch(e){
      console.error(e);
      if ($("err")){ $("err").textContent="⚠️ Error inicializando: "+e.message; $("err").style.display="block"; }
    }
  });
})();
</script>
</body>
</html>
