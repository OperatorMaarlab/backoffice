<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cambio de vuelos · Maarlab</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>

<style>
  :root{
    --card:#fff; --ink:#0b2a5a; --sub:#475569; --border:#e2e8f0;
    --accent:#2bd9a7; --accent2:#40c8ff;
    --oldA:#ffe8ea; --oldB:#ffd2d7; --oldBorder:#c62828;   /* rojo más oscuro */
    --newA:#e7f7ee; --newB:#d1f1de; --newBorder:#15803d;   /* verde más oscuro */
    --muted:#eef2f7;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:15px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,Inter,Roboto,"Segoe UI",system-ui,sans-serif;
    background:#fff;
  }
  /* Fondo Maarlab + velo blanco muy sutil */
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  body::after{content:"";position:fixed;inset:0;z-index:-1;background:linear-gradient(to bottom,rgba(255,255,255,.44),rgba(255,255,255,.66) 45%,rgba(255,255,255,.92))}
  .wrap{max-width:1240px;margin:0 auto;padding:16px}

  /* Barra superior blanca + separador degradado de marca */
  .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:30}
  .barInner{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1240px;margin:0 auto;padding:10px 16px}
  .brandChip{background:linear-gradient(135deg,var(--accent),var(--accent2));padding:6px 12px;border-radius:12px;display:inline-flex;align-items:center}
  .mlogoH{height:22px;display:block;filter:drop-shadow(0 0 0 rgba(0,0,0,.0))} /* logo es blanco, el chip lo hace visible */
  .sep{height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2))}

  .grid2{display:grid;gap:16px}
  @media(min-width:1100px){.grid2{grid-template-columns:2fr 1fr}}
  .btn{border:0;border-radius:12px;padding:10px 14px;color:#0b2a5a;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .chip button{padding:6px 10px;border:0;background:#f1f5f9;cursor:pointer;color:#0b2a5a}
  .chip button.active{background:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px}
  .tiny{font-size:11px;color:#64748b}
  h2{font:700 16px/1.2 Poppins, -apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;margin:0 0 6px}
  label{font-size:12px;color:#334155;display:block;margin-bottom:8px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#0b2a5a}
  input[placeholder]{text-transform:uppercase}
  input.invalid{border-color:#ef4444!important;background:#fff1f2}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

  .logoBoxSq{width:48px;height:48px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoBoxSq img{max-width:100%;max-height:100%;object-fit:contain;display:block}

  /* ===== Visualizador (izquierda) ===== */
  #exportArea{position:relative; font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,Inter,Roboto,"Segoe UI",system-ui,sans-serif;}
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px}
  #hdr-title{font:700 30px Poppins,-apple-system,"Helvetica Neue",Arial}
  .itins{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .itinCol{border:1px solid var(--border);border-radius:14px;padding:12px;min-height:300px}
  .itinOld{background:linear-gradient(180deg,var(--oldA),var(--oldB));border-color:var(--oldBorder)}
  .itinNew{background:linear-gradient(180deg,var(--newA),var(--newB));border-color:var(--newBorder)}
  .leg{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8;margin-top:10px}
  .legHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .codes{font-weight:700;font-size:18px}
  .airLogoBox{height:42px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;min-width:120px}
  .airLogoBox img{max-height:100%;width:auto;display:block}
  .meta{font-size:12px;color:#475569;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:3px 8px;font-size:11px;color:#334155}
  .times{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .times.stop{grid-template-columns:repeat(4,1fr)}
  .big{font-weight:700;font-size:18px}
  .dim{font-size:12px;color:#334155;margin-top:6px}

  .icon{width:14px;height:14px;opacity:.55;vertical-align:-2px;margin-right:6px;filter:grayscale(100%) brightness(0.65) contrast(.9)}
  .prices{display:grid;grid-template-columns:repeat(4,1fr) 1.2fr;gap:12px;margin-top:14px}
  .pill{border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;background:var(--muted)}
  .pill .v{font-weight:700}
  .totalPill{background:linear-gradient(135deg,#e7f3ff,#ecfbff);border-color:#93c5fd}
  .totalPill .v{font-size:22px}
  .notes{margin-top:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px;min-height:60px}
  .foot{display:flex;justify-content:space-between;gap:12px;margin-top:12px;color:#64748b;font-size:12px;align-items:center}

  /* Hotel opcional */
  .hotelBox{display:none;align-items:center;justify-content:space-between;gap:10px;margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8}
  .hotelLogo{width:56px;height:56px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .hotelLogo img{max-width:100%;max-height:100%;object-fit:contain}

  /* ===== Print (PDF nativo) ===== */
  @media print{
    body{background:#fff}
    .bar, .sep, #panel, .btnPdfHide{display:none!important}
    #exportArea{page-break-inside:avoid}
    *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
    @page{size:A4 landscape;margin:10mm}
  }
</style>
</head>
<body>
  <!-- TOP -->
  <div class="bar">
    <div class="barInner">
      <span class="brandChip">
        <img class="mlogoH" alt="Maarlab" src="https://maarlab.com/wp-content/uploads/2024/09/maarlab-footer.svg" crossorigin="anonymous" referrerpolicy="no-referrer">
      </span>
      <div style="display:flex;gap:10px;align-items:center">
        <!-- Idiomas -->
        <div class="chip" id="chipLang">
          <button data-lang="es" class="active">ES</button>
          <button data-lang="en">EN</button>
          <button data-lang="fr">FR</button>
          <button data-lang="it">IT</button>
          <button data-lang="de">DE</button>
        </div>
        <!-- Monedas -->
        <div class="chip" id="chipCurrency">
          <button data-cur="EUR" class="active">EUR</button>
          <button data-cur="USD">USD</button>
          <button data-cur="MXN">MXN</button>
        </div>
      </div>
    </div>
    <div class="sep"></div>
  </div>

  <main class="wrap grid2">
    <!-- ===== Visualizador (izquierda) ===== -->
    <section class="card" id="cardWrap">
      <div id="exportArea">
        <div class="headerRow">
          <div>
            <div class="tiny" id="hdr-sub">Cambio de vuelos · Round Trip</div>
            <div id="hdr-title">Cambio de vuelos</div>
            <div class="tiny" id="hdr-dates">Ida: — → — · Vuelta: — → —</div>
            <div class="badges" id="locBadges"></div>
          </div>
          <div class="logoBoxSq"><img id="maarlabLogoM" alt="M" crossorigin="anonymous" referrerpolicy="no-referrer" src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg"></div>
        </div>

        <div class="itins">
          <!-- Anterior -->
          <div class="itinCol itinOld">
            <div style="font:700 14px Poppins, -apple-system,'Helvetica Neue',Arial" id="prevTitle">Itinerario anterior</div>

            <div class="leg" id="leg-oo">
              <div class="legHead">
                <div>
                  <div class="codes" id="ooCodes">XXX → XXX</div>
                  <div class="tiny" id="ooCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-oo" alt="air-oo" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="ooMeta">Vuelo — Fecha</span><div class="badges" id="ooBadges"></div></div>
              <div class="times" id="ooTimes"></div>
              <div class="dim" id="ooDur">Duración: —</div>
            </div>

            <div class="leg" id="leg-or">
              <div class="legHead">
                <div>
                  <div class="codes" id="orCodes">XXX → XXX</div>
                  <div class="tiny" id="orCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-or" alt="air-or" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="orMeta">Vuelo — Fecha</span><div class="badges" id="orBadges"></div></div>
              <div class="times" id="orTimes"></div>
              <div class="dim" id="orDur">Duración: —</div>
            </div>
          </div>

          <!-- Nuevo -->
          <div class="itinCol itinNew">
            <div style="font:700 14px Poppins, -apple-system,'Helvetica Neue',Arial" id="newTitle">Itinerario nuevo</div>

            <div class="leg" id="leg-no">
              <div class="legHead">
                <div>
                  <div class="codes" id="noCodes">XXX → XXX</div>
                  <div class="tiny" id="noCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-no" alt="air-no" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="noMeta">Vuelo — Fecha</span><div class="badges" id="noBadges"></div></div>
              <div class="times" id="noTimes"></div>
              <div class="dim" id="noDur">Duración: —</div>
            </div>

            <div class="leg" id="leg-nr">
              <div class="legHead">
                <div>
                  <div class="codes" id="nrCodes">XXX → XXX</div>
                  <div class="tiny" id="nrCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-nr" alt="air-nr" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="nrMeta">Vuelo — Fecha</span><div class="badges" id="nrBadges"></div></div>
              <div class="times" id="nrTimes"></div>
              <div class="dim" id="nrDur">Duración: —</div>
            </div>
          </div>
        </div>

        <!-- Hotel (opcional: nombre + logo local) -->
        <div class="hotelBox" id="hotelBox">
          <div>
            <div class="tiny" id="hotelCaption">Hotel</div>
            <div class="big" id="hotelName">—</div>
          </div>
          <div class="hotelLogo"><img id="hotelLogoImg" alt="hotel-logo"></div>
        </div>

        <!-- Precios -->
        <div class="prices">
          <div class="pill"><div class="tiny" id="penLabel">Penalización</div><div class="v" id="penVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="feeLabel">Fee servicio</div><div class="v" id="feeVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="fareLabel">Diferencia de tarifa</div><div class="v" id="fareVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="ppLabel">Total por pax</div><div class="v" id="ppVal">€0,00</div></div>
          <div class="pill totalPill"><div class="tiny" id="totLabel">Total a pagar</div><div class="v" id="totVal">€0,00</div></div>
        </div>

        <!-- Notas -->
        <div class="notes" contenteditable="true" id="notesBox">Notas / Notes…</div>
      </div>

      <div class="foot">
        <div class="tiny" id="footerText">Generado por Maarlab · Contacto: booking@maarlab.com</div>
        <div class="btnPdfHide" style="display:flex;gap:8px">
          <button id="btnPng" class="btn" disabled>PNG</button>
          <button id="btnPdf" class="btn" disabled>PDF</button>
        </div>
      </div>
    </section>

    <!-- ===== Formulario (derecha) ===== -->
    <aside class="card" id="panel">
      <h2 id="hOut">Ruta (ida)</h2>
      <div class="row">
        <label id="lblOutFrom">Origen (IATA) <input id="outFrom" list="iataList" placeholder="TFN" data-iata="outFromCity"></label>
        <label id="lblOutFromCity">Ciudad origen <input id="outFromCity" placeholder="Tenerife Norte"></label>
        <label id="lblOutTo">Destino (IATA) <input id="outTo" list="iataList" placeholder="MAD" data-iata="outToCity"></label>
        <label id="lblOutToCity">Ciudad destino <input id="outToCity" placeholder="Madrid"></label>
      </div>

      <h2 id="hRet" style="margin-top:12px">Ruta (vuelta)</h2>
      <div class="row">
        <label id="lblRetFrom">Origen (IATA) <input id="retFrom" list="iataList" placeholder="MAD" data-iata="retFromCity"></label>
        <label id="lblRetFromCity">Ciudad origen <input id="retFromCity" placeholder="Madrid"></label>
        <label id="lblRetTo">Destino (IATA) <input id="retTo" list="iataList" placeholder="TFN" data-iata="retToCity"></label>
        <label id="lblRetToCity">Ciudad destino <input id="retToCity" placeholder="Tenerife Norte"></label>
      </div>

      <h2 id="hPrev" style="margin-top:14px">Itinerario anterior</h2>
      <div class="row">
        <label><span id="lblOOAirTxt">Ida — Aerolínea (código)</span> <input id="ooAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label><span id="lblOONumTxt">Ida — N.º vuelo</span> <input id="ooNum" placeholder="3478"></label>
        <label id="lblOODep"><span>Ida — Salida</span> <input id="ooDep" placeholder="10:30"></label>
        <label id="lblOOArr"><span>Ida — Llegada</span> <input id="ooArr" placeholder="12:50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span id="lblORAirTxt">Vuelta — Aerolínea (código)</span> <input id="orAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label><span id="lblORNumTxt">Vuelta — N.º vuelo</span> <input id="orNum" placeholder="3479"></label>
        <label id="lblORDep"><span>Vuelta — Salida</span> <input id="orDep" placeholder="17:20"></label>
        <label id="lblORArr"><span>Vuelta — Llegada</span> <input id="orArr" placeholder="19:35"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span>Ida — Fecha</span> <input id="ooDate" type="date"></label>
        <label><span>Vuelta — Fecha</span> <input id="orDate" type="date"></label>
      </div>

      <h2 id="hNew" style="margin-top:14px">Itinerario nuevo</h2>
      <div class="row">
        <label><span id="lblNOAirTxt">Ida — Aerolínea (código)</span> <input id="noAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label><span id="lblNONumTxt">Ida — N.º vuelo</span> <input id="noNum" placeholder="1234"></label>
        <label id="lblNODep"><span>Ida — Salida</span> <input id="noDep" placeholder="11:15"></label>
        <label id="lblNOArr"><span>Ida — Llegada</span> <input id="noArr" placeholder="13:40"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span id="lblNRAirTxt">Vuelta — Aerolínea (código)</span> <input id="nrAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label><span id="lblNRNumTxt">Vuelta — N.º vuelo</span> <input id="nrNum" placeholder="1235"></label>
        <label id="lblNRDep"><span>Vuelta — Salida</span> <input id="nrDep" placeholder="18:10"></label>
        <label id="lblNRArr"><span>Vuelta — Llegada</span> <input id="nrArr" placeholder="20:30"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label><span>Ida — Fecha</span> <input id="noDate" type="date"></label>
        <label><span>Vuelta — Fecha</span> <input id="nrDate" type="date"></label>
      </div>

      <details style="margin-top:8px">
        <summary id="stopsSummary">Escalas (opcionales)</summary>
        <div class="row" style="margin-top:8px">
          <label>Old Out — Stop (IATA) <input id="ooStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="ooStopArr" placeholder="11:20"></label>
          <label>Depart stop (HH:MM) <input id="ooStopDep" placeholder="12:05"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>Old Ret — Stop (IATA) <input id="orStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="orStopArr" placeholder="18:05"></label>
          <label>Depart stop (HH:MM) <input id="orStopDep" placeholder="18:50"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>New Out — Stop (IATA) <input id="noStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="noStopArr" placeholder="12:00"></label>
          <label>Depart stop (HH:MM) <input id="noStopDep" placeholder="12:45"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>New Ret — Stop (IATA) <input id="nrStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="nrStopArr" placeholder="21:00"></label>
          <label>Depart stop (HH:MM) <input id="nrStopDep" placeholder="21:40"></label>
          <div></div>
        </div>
      </details>

      <h2 style="margin-top:14px" id="hHotel">Hotel (opcional)</h2>
      <div class="row">
        <label id="lblHotelName">Nombre de hotel <input id="hotelNameInput" placeholder="Spring Arona Gran"></label>
        <label>Logo del hotel (archivo) <input id="hotelLogoFile" type="file" accept="image/*"></label>
      </div>

      <h2 style="margin-top:14px" id="hRefs">Localizadores (opcional)</h2>
      <div class="row">
        <label id="lblBkRef">Localizador reserva <input id="bookingRef" placeholder="ABC123"></label>
        <label id="lblMlRef">Localizador Maarlab <input id="maarlabRef" placeholder="MLB-0001"></label>
      </div>

      <h2 id="hCosts" style="margin-top:14px">Costes</h2>
      <div class="row-3">
        <label id="lblPenalty">Penalización <input id="penalty" placeholder="150,00"></label>
        <label id="lblFee">Fee servicio <input id="fee" placeholder="30,00"></label>
        <label id="lblFare">Diferencia de tarifa <input id="fareDiff" placeholder="45,50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label id="lblPax">Pax <input id="pax" type="number" min="1" step="1" value="1"></label>
        <div></div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="ncAgree">
          <span class="tiny" id="ncText">Confirmo que este material es informativo y <b>no</b> tiene fines comerciales. Puedes exportar o hacer captura.</span>
        </label>
        <div style="flex:1"></div>
        <button id="btnPng2" class="btn" disabled>PNG</button>
        <button id="btnPdf2" class="btn" disabled>PDF</button>
      </div>

      <details id="adv" style="margin-top:12px">
        <summary id="advSummary">Opciones avanzadas</summary>
        <div class="row" style="margin-top:8px">
          <label id="lblBaseUrl">Logos aerolíneas (base URL) <input id="airlineBase"></label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="fxEnable" checked> <span id="fxLabel">Convertir desde EUR</span>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>1 EUR = USD <input id="fxUSD" value="1.08"></label>
          <label>1 EUR = MXN <input id="fxMXN" value="19.00"></label>
        </div>
      </details>
    </aside>
  </main>

  <!-- datalists -->
  <datalist id="airlineCodes"></datalist>
  <datalist id="iataList"></datalist>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
const $ = id=>document.getElementById(id);
/* iconos */
const ICON_DEP = "https://cdn-icons-png.flaticon.com/512/565/565514.png";
const ICON_ARR = "https://www.svgrepo.com/show/352351/plane-arrival.svg";

/* ===== i18n ===== */
const STR = {
  es:{hdrSub:"Cambio de vuelos · Round Trip",hdrTitle:"Cambio de vuelos",
      outTitle:"Ruta (ida)",retTitle:"Ruta (vuelta)",prev:"Itinerario anterior",next:"Itinerario nuevo",
      dep:"Salida",arr:"Llegada",arrStop:"Llegada escala",depStop:"Salida escala",duration:"Duración", layover:"Escala",
      costs:"Costes",penalty:"Penalización",fee:"Fee servicio",fare:"Diferencia de tarifa",total:"Total a pagar", perPax:"Total por pax",
      baseUrl:"Logos aerolíneas (base URL)",adv:"Opciones avanzadas",fx:"Convertir desde EUR",
      nc:"Confirmo que este material es informativo y no tiene fines comerciales. Puedes exportar o hacer captura.",
      footer:"Generado por Maarlab · Contacto: booking@maarlab.com",
      exportWarn:"Debes confirmar uso informativo / no comercial.",
      exportFail:"No se pudo exportar. Se exportará sin logos si el servidor bloquea CORS.",
      stops:"Escalas (opcionales)",
      badges:{plusDays:"+{n} día(s)", tz:"ΔTZ {h}h", dst:"DST", odd:"Duración inusual"}},
  en:{hdrSub:"Flight change · Round Trip",hdrTitle:"Flight change",
      outTitle:"Outbound",retTitle:"Return",prev:"Previous itinerary",next:"New itinerary",
      dep:"Departure",arr:"Arrival",arrStop:"Arrive stop",depStop:"Depart stop",duration:"Duration", layover:"Layover",
      costs:"Costs",penalty:"Penalty",fee:"Service fee",fare:"Fare difference",total:"Total to pay", perPax:"Per pax total",
      baseUrl:"Airline logos (base URL)",adv:"Advanced options",fx:"Convert from EUR",
      nc:"I confirm this is informational and non-commercial. You may export or take a screenshot.",
      footer:"Generated by Maarlab · Contact: booking@maarlab.com",
      exportWarn:"Please confirm non-commercial use.",
      exportFail:"Export failed. It will export without logos if the server blocks CORS.",
      stops:"Stops (optional)",
      badges:{plusDays:"+{n} day(s)", tz:"ΔTZ {h}h", dst:"DST", odd:"Odd duration"}},
  fr:{hdrSub:"Changement de vols · Aller-retour",hdrTitle:"Changement de vols",
      outTitle:"Aller",retTitle:"Retour",prev:"Itinéraire précédent",next:"Nouvel itinéraire",
      dep:"Départ",arr:"Arrivée",arrStop:"Arrivée escale",depStop:"Départ escale",duration:"Durée", layover:"Escale",
      costs:"Coûts",penalty:"Pénalité",fee:"Frais de service",fare:"Différence tarifaire",total:"Total à payer", perPax:"Total par pax",
      baseUrl:"Logos compagnies (base URL)",adv:"Options avancées",fx:"Convertir depuis EUR",
      nc:"Je confirme l'usage informatif et non commercial. Export ou capture autorisé.",
      footer:"Généré par Maarlab · Contact : booking@maarlab.com",
      exportWarn:"Veuillez confirmer l'usage non commercial.",
      exportFail:"Échec d'exportation. Export sans logos si CORS est bloqué.",
      stops:"Escales (optionnel)",
      badges:{plusDays:"+{n} jour(s)", tz:"ΔTZ {h}h", dst:"Heure d'été", odd:"Durée inhabituelle"}},
  it:{hdrSub:"Cambio voli · Andata/Ritorno",hdrTitle:"Cambio voli",
      outTitle:"Andata",retTitle:"Ritorno",prev:"Itinerario precedente",next:"Nuovo itinerario",
      dep:"Partenza",arr:"Arrivo",arrStop:"Arrivo scalo",depStop:"Partenza scalo",duration:"Durata", layover:"Scalo",
      costs:"Costi",penalty:"Penale",fee:"Costo servizio",fare:"Differenza tariffa",total:"Totale da pagare", perPax:"Totale per pax",
      baseUrl:"Loghi compagnie (URL base)",adv:"Opzioni avanzate",fx:"Convertire da EUR",
      nc:"Confermo uso informativo e non commerciale. Puoi esportare o fare screenshot.",
      footer:"Generato da Maarlab · Contatto: booking@maarlab.com",
      exportWarn:"Conferma uso non commerciale.",
      exportFail:"Esportazione fallita. Esporterà senza loghi se CORS è bloccato.",
      stops:"Scali (opzionali)",
      badges:{plusDays:"+{n} giorno/i", tz:"ΔTZ {h}h", dst:"Ora legale", odd:"Durata insolita"}},
  de:{hdrSub:"Flugänderung · Hin- und Rückflug",hdrTitle:"Flugänderung",
      outTitle:"Hinflug",retTitle:"Rückflug",prev:"Bisherige Reiseroute",next:"Neue Reiseroute",
      dep:"Abflug",arr:"Ankunft",arrStop:"Ankunft Zwischenstopp",depStop:"Abflug Zwischenstopp",duration:"Dauer", layover:"Zwischenstopp",
      costs:"Kosten",penalty:"Strafgebühr",fee:"Servicegebühr",fare:"Tarifdifferenz",total:"Gesamt zu zahlen", perPax:"Gesamt pro Pax",
      baseUrl:"Airline-Logos (Basis-URL)",adv:"Erweiterte Optionen",fx:"Von EUR umrechnen",
      nc:"Ich bestätige den informativen, nicht-kommerziellen Zweck. Export/Screenshot erlaubt.",
      footer:"Erstellt von Maarlab · Kontakt: booking@maarlab.com",
      exportWarn:"Bitte nicht-kommerzielle Nutzung bestätigen.",
      exportFail:"Export fehlgeschlagen. Export ohne Logos wenn CORS blockiert.",
      stops:"Stopps (optional)",
      badges:{plusDays:"+{n} Tag(e)", tz:"ΔTZ {h}h", dst:"Sommerzeit", odd:"Ungewöhnliche Dauer"}}
};
let LANG="es";

/* ===== datos ===== */
const DEFAULT_AIRLINE_BASE = "https://maarlabcdnstorage.blob.core.windows.net/web-assets/images/airlines";
const DEFAULT_MAARLAB_MARK = "https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg";
/* Aerolíneas (incluye F8/F9 y alias U→U2) */
const AIRLINES = {
  "U":"easyJet","U2":"easyJet",
  "AM":"Aeroméxico","Y4":"Volaris","VB":"VivaAerobus","LA":"LATAM","AR":"Aerolíneas Argentinas","CM":"Copa Airlines",
  "AV":"Avianca","G3":"GOL","H2":"Sky Airline","QP":"Amaszonas","VE":"EasyFly",
  "IB":"Iberia","I2":"Iberia Express","VY":"Vueling","UX":"Air Europa","NT":"Binter Canarias","FR":"Ryanair",
  "W6":"Wizz Air","W4":"Wizz Air Malta","TO":"Transavia France","HV":"Transavia","BA":"British Airways",
  "KL":"KLM","AF":"Air France","LH":"Lufthansa","LX":"SWISS","OS":"Austrian","SN":"Brussels Airlines","LO":"LOT",
  "SK":"SAS","DY":"Norwegian","EW":"Eurowings","A3":"Aegean","OA":"Olympic","TK":"Turkish Airlines","PC":"Pegasus",
  "RO":"TAROM","OU":"Croatia Airlines","JU":"Air Serbia","BT":"airBaltic","AY":"Finnair","OK":"Czech Airlines",
  "RK":"Lauda Europe","X3":"TUIfly","XQ":"SunExpress","QS":"Smartwings","FB":"Bulgaria Air","KM":"Air Malta",
  "QR":"Qatar Airways","EK":"Emirates","EY":"Etihad","RJ":"Royal Jordanian","SV":"Saudia","ME":"MEA","MS":"Egyptair",
  "F8":"Frontier","F9":"Frontier","AA":"American Airlines","UA":"United","DL":"Delta","B6":"JetBlue","WN":"Southwest","NK":"Spirit",
  "AS":"Alaska Airlines","HA":"Hawaiian","AC":"Air Canada","WS":"WestJet","TS":"Air Transat",
  "EI":"Aer Lingus","LS":"Jet2","BE":"Flybe"
};
const LOGO_FALLBACK = { "F8":"F9", "U":"U2" };

/* IATA → ciudad (resumen ampliado) */
const IATA_DB = {
  "MAD":"Madrid","BCN":"Barcelona","VLC":"Valencia","AGP":"Málaga","SVQ":"Sevilla","BIO":"Bilbao","PMI":"Palma de Mallorca",
  "IBZ":"Ibiza","ALC":"Alicante","TFN":"Tenerife Norte","TFS":"Tenerife Sur","LPA":"Gran Canaria","ACE":"Lanzarote","FUE":"Fuerteventura",
  "LIS":"Lisboa","OPO":"Oporto","FAO":"Faro","FNC":"Madeira",
  "CDG":"París (CDG)","ORY":"París (Orly)","NCE":"Niza","LYS":"Lyon","MRS":"Marsella","BRU":"Bruselas",
  "AMS":"Ámsterdam","EIN":"Eindhoven","RTM":"Róterdam",
  "FRA":"Fráncfort","MUC":"Múnich","BER":"Berlín","DUS":"Düsseldorf","HAM":"Hamburgo","STR":"Stuttgart","CGN":"Colonia/Bonn",
  "VIE":"Viena","ZRH":"Zúrich","GVA":"Ginebra",
  "FCO":"Roma (Fiumicino)","CIA":"Roma (Ciampino)","MXP":"Milán (Malpensa)","LIN":"Milán (Linate)","BGY":"Bérgamo",
  "LHR":"Londres (Heathrow)","LGW":"Londres (Gatwick)","LTN":"Londres (Luton)","STN":"Londres (Stansted)","LCY":"Londres (City)",
  "MAN":"Mánchester","LPL":"Liverpool","EMA":"East Midlands","DUB":"Dublín","EDI":"Edimburgo","GLA":"Glasgow",
  "MEX":"Ciudad de México","GDL":"Guadalajara","MTY":"Monterrey","CUN":"Cancún","TQO":"Tulum (Felipe Carrillo Puerto)","CZM":"Cozumel",
  "HUX":"Huatulco","PVR":"Puerto Vallarta","ACA":"Acapulco","QRO":"Querétaro","BJX":"León/Guanajuato","TIJ":"Tijuana","SJD":"Los Cabos",
  "DFW":"Dallas/Fort Worth","EWR":"Newark","JFK":"Nueva York (JFK)","LGA":"Nueva York (LGA)","LAX":"Los Ángeles","SFO":"San Francisco",
  "MIA":"Miami","ORD":"Chicago O'Hare","ATL":"Atlanta","SEA":"Seattle","BOS":"Boston","IAD":"Washington Dulles","DCA":"Washington National",
  "PHL":"Filadelfia","IAH":"Houston Intercontinental","HOU":"Houston Hobby","PHX":"Phoenix","DEN":"Denver","MSP":"Minneapolis",
  "IST":"Estambul","ATH":"Atenas","CPH":"Copenhague","OSL":"Oslo","ARN":"Estocolmo","HEL":"Helsinki","PRG":"Praga","WAW":"Varsovia"
};
/* IATA → TZ IANA */
const TZ_DB = {
  "MAD":"Europe/Madrid","BCN":"Europe/Madrid","VLC":"Europe/Madrid","AGP":"Europe/Madrid","SVQ":"Europe/Madrid","BIO":"Europe/Madrid",
  "TFN":"Atlantic/Canary","TFS":"Atlantic/Canary","LPA":"Atlantic/Canary","ACE":"Atlantic/Canary","FUE":"Atlantic/Canary",
  "PMI":"Europe/Madrid","IBZ":"Europe/Madrid","ALC":"Europe/Madrid",
  "LIS":"Europe/Lisbon","OPO":"Europe/Lisbon","FAO":"Europe/Lisbon","FNC":"Atlantic/Madeira",
  "CDG":"Europe/Paris","ORY":"Europe/Paris","NCE":"Europe/Paris","LYS":"Europe/Paris","MRS":"Europe/Paris","BRU":"Europe/Brussels",
  "AMS":"Europe/Amsterdam","EIN":"Europe/Amsterdam","RTM":"Europe/Amsterdam",
  "FRA":"Europe/Berlin","MUC":"Europe/Berlin","BER":"Europe/Berlin","DUS":"Europe/Berlin","HAM":"Europe/Berlin","STR":"Europe/Berlin","CGN":"Europe/Berlin",
  "VIE":"Europe/Vienna","ZRH":"Europe/Zurich","GVA":"Europe/Zurich",
  "FCO":"Europe/Rome","CIA":"Europe/Rome","MXP":"Europe/Rome","LIN":"Europe/Rome","BGY":"Europe/Rome",
  "LHR":"Europe/London","LGW":"Europe/London","LTN":"Europe/London","STN":"Europe/London","LCY":"Europe/London",
  "MAN":"Europe/London","LPL":"Europe/London","EMA":"Europe/London","DUB":"Europe/Dublin","EDI":"Europe/London","GLA":"Europe/London",
  "MEX":"America/Mexico_City","GDL":"America/Mexico_City","MTY":"America/Monterrey","CUN":"America/Cancun","TQO":"America/Cancun","CZM":"America/Cancun",
  "HUX":"America/Mexico_City","PVR":"America/Mexico_City","ACA":"America/Mexico_City","QRO":"America/Mexico_City","BJX":"America/Mexico_City",
  "TIJ":"America/Tijuana","SJD":"America/Mazatlan",
  "DFW":"America/Chicago","EWR":"America/New_York","JFK":"America/New_York","LGA":"America/New_York","LAX":"America/Los_Angeles","SFO":"America/Los_Angeles",
  "MIA":"America/New_York","ORD":"America/Chicago","ATL":"America/New_York","SEA":"America/Los_Angeles","BOS":"America/New_York",
  "IAD":"America/New_York","DCA":"America/New_York","PHL":"America/New_York","IAH":"America/Chicago","HOU":"America/Chicago",
  "PHX":"America/Phoenix","DEN":"America/Denver","MSP":"America/Chicago",
  "IST":"Europe/Istanbul","ATH":"Europe/Athens","CPH":"Europe/Copenhagen","OSL":"Europe/Oslo","ARN":"Europe/Stockholm","HEL":"Europe/Helsinki",
  "PRG":"Europe/Prague","WAW":"Europe/Warsaw"
};

/* ===== formato / helpers ===== */
let CUR="EUR";
const { DateTime } = luxon;
const nf = (cur,lang)=>new Intl.NumberFormat(
  lang==="en"?"en-US":lang==="fr"?"fr-FR":lang==="it"?"it-IT":lang==="de"?"de-DE":"es-ES",
  {style:"currency",currency:cur,minimumFractionDigits:2,maximumFractionDigits:2}
);
const parseMoney = s => { const t=String(s||"").replace(/\./g,"").replace(",","."); const n=parseFloat(t); return isFinite(n)?n:0; };
const normalizeCode = c => (c||"").toUpperCase();
const airlineLogoUrl = code => ( ($("airlineBase")?.value || DEFAULT_AIRLINE_BASE).replace(/\/$/,"") + "/" + code + ".png" );
const fmtDate = (val)=>{ if(!val) return "—"; const [y,m,d]=String(val).split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:val; };
const HM_RE = /^([01]\d|2[0-3]):[0-5]\d$/;
let hotelLogoData = ""; // dataURL de logo hotel local

function dayOfWeek(dateISO){
  if(!dateISO) return "";
  const map = {es:"es",en:"en",fr:"fr",it:"it",de:"de"};
  const locale = map[LANG] || "es";
  try{ return DateTime.fromISO(dateISO).setLocale(locale).toFormat("cccc"); }catch{ return ""; }
}
function zonedDT(dateISO, hm, iata){
  if(!dateISO || !HM_RE.test(hm) || !iata) return null;
  const z = TZ_DB[normalizeCode(iata)] || "UTC";
  return DateTime.fromISO(`${dateISO}T${hm}`, { zone: z });
}
function segmentMinutes(dateISO, depHM, arrHM, fromIata, toIata){
  const dep = zonedDT(dateISO, depHM, fromIata);
  const arr = zonedDT(dateISO, arrHM, toIata);
  if(!dep || !arr) return NaN;
  let diff = arr.toUTC().diff(dep.toUTC(), "minutes").minutes;
  while(diff < 0) diff += 1440;
  return diff;
}
function layoverMinutes(dateISO, arrHM, depHM, stopIata){
  const arr = zonedDT(dateISO, arrHM, stopIata);
  const dep = zonedDT(dateISO, depHM, stopIata);
  if(!arr || !dep) return NaN;
  let diff = dep.diff(arr, "minutes").minutes;
  while(diff < 0) diff += 1440;
  return diff;
}
const fmtHM = m => isFinite(m)?(`${Math.floor(Math.abs(m)/60)}h ${Math.abs(m)%60}m`):"—";

/* Precios / moneda */
function moneyOut(v){
  const fxOn = $("#fxEnable")?.checked;
  const lang = LANG;
  if(CUR==="EUR") return nf("EUR",lang).format(v);
  if(!fxOn) return nf(CUR,lang).format(v);
  const usd = Number($("#fxUSD").value||1.08);
  const mxn = Number($("#fxMXN").value||19.0);
  if(CUR==="USD") return nf("USD",lang).format(v*usd);
  if(CUR==="MXN") return nf("MXN",lang).format(v*mxn);
  return nf(CUR,lang).format(v);
}

/* i18n */
function applyI18n(){
  const S=STR[LANG];
  $("#hdr-sub").textContent = S.hdrSub;
  $("#hdr-title").textContent = S.hdrTitle;
  $("#prevTitle").textContent=S.prev; $("#newTitle").textContent=S.next;
  $("#hOut").textContent = S.outTitle; $("#hRet").textContent=S.retTitle;
  $("#hCosts").textContent=S.costs; $("#penLabel").textContent=S.penalty; $("#feeLabel").textContent=S.fee;
  $("#fareLabel").textContent=S.fare; $("#ppLabel").textContent=S.perPax; $("#totLabel").textContent=S.total;
  $("#advSummary").textContent=S.adv;
  const lblBase=$("#lblBaseUrl"); if(lblBase && lblBase.firstChild) lblBase.firstChild.textContent=S.baseUrl+" ";
  $("#fxLabel").textContent=S.fx; $("#ncText").textContent=S.nc; $("#footerText").textContent=S.footer;
  $("#stopsSummary").textContent=S.stops;
  document.querySelectorAll("#btnPdf,#btnPdf2").forEach(b=>b.textContent="PDF");
  document.querySelectorAll("#btnPng,#btnPng2").forEach(b=>b.textContent="PNG");
  refresh();
}

/* Badges inteligentes */
function buildBadges(dateISO, depHM, arrHM, fromIata, toIata){
  const S = STR[LANG].badges;
  const dep = zonedDT(dateISO, depHM, fromIata);
  const arr = zonedDT(dateISO, arrHM, toIata);
  if(!dep || !arr) return [];
  const badges = [];
  const depLocal = dep.setZone(TZ_DB[fromIata]||dep.zoneName);
  const arrLocal = arr.setZone(TZ_DB[toIata]||arr.zoneName);
  const plusDays = Math.floor(arrLocal.startOf("day").diff(depLocal.startOf("day"), "days").days);
  if(plusDays>0) badges.push(S.plusDays.replace("{n}", plusDays));
  const deltaH = (arr.offset - dep.offset)/60;
  if(deltaH!==0) badges.push(S.tz.replace("{h}", (deltaH>0?"+":"")+deltaH));
  if(dep.zoneName===arr.zoneName && dep.offset!==arr.offset) badges.push(S.dst);
  const m = segmentMinutes(dateISO, depHM, arrHM, fromIata, toIata);
  if(isFinite(m) && (m<30 || m>960)) badges.push(S.odd);
  return badges;
}

/* Logos aerolínea */
function setLegLogo(imgId, code){
  const img=$(imgId); if(!img) return;
  const raw = normalizeCode(code);
  if(!raw){ img.style.visibility="hidden"; img.removeAttribute("src"); return; }
  const fallback = LOGO_FALLBACK[raw] ? normalizeCode(LOGO_FALLBACK[raw]) : "";
  img.style.visibility="visible";
  img.dataset.fallbackTried = "0";
  img.onerror = () => {
    if(fallback && img.dataset.fallbackTried==="0"){
      img.dataset.fallbackTried="1";
      img.src = airlineLogoUrl(fallback);
    }else{
      img.style.visibility="hidden"; img.removeAttribute("src");
    }
  };
  img.crossOrigin="anonymous"; img.referrerPolicy="no-referrer";
  img.src = airlineLogoUrl(raw);
}

/* Render leg (con escala opcional y DOW en meta) */
function renderLeg(prefix, fromIata, toIata, cityFrom, cityTo){
  const S=STR[LANG];
  const code = normalizeCode($(prefix+"Air").value);
  const num  = ($(prefix+"Num").value||"").toUpperCase();
  const dateISO = (prefix.startsWith("o") ? (prefix==="oo" ? $("#ooDate").value : $("#orDate").value)
                                         : (prefix==="no" ? $("#noDate").value : $("#nrDate").value));
  const dow = dayOfWeek(dateISO);
  const stop = normalizeCode($(prefix+"Stop")?.value || "");
  const stopArr = $(prefix+"StopArr")?.value || "";
  const stopDep = $(prefix+"StopDep")?.value || "";

  $("#"+prefix+"Codes").textContent = `${fromIata} → ${toIata}`;
  $("#"+prefix+"Cities").textContent = `${cityFrom} → ${cityTo}`;
  const dateTxt = dateISO ? `${dow} ${fmtDate(dateISO)}` : "—";
  $("#"+prefix+"Meta").textContent = `${(code||"")}${(num||"")} · ${(AIRLINES[code]||"—")} · ${dateTxt}`;
  setLegLogo("logo-"+prefix, code);

  const $badges = $("#"+prefix+"Badges"); $badges.innerHTML="";
  buildBadges(dateISO, $("#"+prefix+"Dep").value, $("#"+prefix+"Arr").value, fromIata, toIata).forEach(t=>{
    const b=document.createElement("span"); b.className="badge"; b.textContent=t; $badges.appendChild(b);
  });

  const $times = $("#"+prefix+"Times"); $times.innerHTML="";
  const cell = (lbl,val,kind)=>{
    const w=document.createElement("div");
    const l=document.createElement("div"); l.className="tiny";
    const ic=document.createElement("img"); ic.className="icon"; ic.alt=kind||""; ic.crossOrigin="anonymous"; ic.referrerPolicy="no-referrer";
    ic.src = (kind==="dep"||kind==="depStop")?ICON_DEP:ICON_ARR;
    l.appendChild(ic); l.appendChild(document.createTextNode(lbl));
    const v=document.createElement("div"); v.className="big"; v.textContent=val||"--:--";
    w.appendChild(l); w.appendChild(v); return w;
  };

  let totalM = NaN, layM = NaN;
  const depHM = $("#"+prefix+"Dep").value, arrHM=$("#"+prefix+"Arr").value;

  if(stop && HM_RE.test(stopArr||"") && HM_RE.test(stopDep||"")){
    $times.classList.add("stop");
    $times.appendChild(cell(S.dep, depHM, "dep"));
    $times.appendChild(cell(S.arrStop, stopArr, "arrStop"));
    $times.appendChild(cell(S.depStop, stopDep, "depStop"));
    $times.appendChild(cell(S.arr, arrHM, "arr"));
    const seg1 = segmentMinutes(dateISO, depHM, stopArr, fromIata, stop);
    const seg2 = segmentMinutes(dateISO, stopDep, arrHM, stop, toIata);
    layM = layoverMinutes(dateISO, stopArr, stopDep, stop);
    totalM = (isFinite(seg1)?seg1:0) + (isFinite(seg2)?seg2:0);
  }else{
    $times.classList.remove("stop");
    $times.appendChild(cell(S.dep, depHM, "dep"));
    $times.appendChild(cell(S.arr, arrHM, "arr"));
    totalM = segmentMinutes(dateISO, depHM, arrHM, fromIata, toIata);
  }
  $("#"+prefix+"Dur").textContent = `${S.duration}: ${isFinite(totalM)?fmtHM(totalM):"—"}${isFinite(layM)?` · ${S.layover}: ${fmtHM(layM)}`:""}`;
}

/* Refresh global */
function refresh(){
  const outFrom=normalizeCode($("#outFrom").value||"XXX"), outTo=normalizeCode($("#outTo").value||"XXX");
  const retFrom=normalizeCode($("#retFrom").value||"XXX"), retTo=normalizeCode($("#retTo").value||"XXX");
  const outFromCity=$("#outFromCity").value||"—", outToCity=$("#outToCity").value||"—";
  const retFromCity=$("#retFromCity").value||"—", retToCity=$("#retToCity").value||"—";

  const ood=fmtDate($("#ooDate").value), ord=fmtDate($("#orDate").value), nod=fmtDate($("#noDate").value), nrd=fmtDate($("#nrDate").value);
  const oodD=dayOfWeek($("#ooDate").value), ordD=dayOfWeek($("#orDate").value), nodD=dayOfWeek($("#noDate").value), nrdD=dayOfWeek($("#nrDate").value);

  $("#hdr-dates").textContent =
    `${LANG==="es"? "Ida":LANG==="fr"?"Aller":LANG==="it"?"Andata":LANG==="de"?"Hinflug":"Out"}: ${oodD?oodD+" ":""}${ood} → ${nodD?nodD+" ":""}${nod} · `+
    `${LANG==="es"?"Vuelta":LANG==="fr"?"Retour":LANG==="it"?"Ritorno":LANG==="de"?"Rückflug":"Return"}: ${ordD?ordD+" ":""}${ord} → ${nrdD?nrdD+" ":""}${nrd}`;

  renderLeg("oo", outFrom, outTo, outFromCity, outToCity);
  renderLeg("or", retFrom, retTo, retFromCity, retToCity);
  renderLeg("no", outFrom, outTo, outFromCity, outToCity);
  renderLeg("nr", retFrom, retTo, retFromCity, retToCity);

  const p=parseMoney($("#penalty").value), f=parseMoney($("#fee").value), d=parseMoney($("#fareDiff").value);
  const pax = Math.max(1, parseInt($("#pax").value||"1",10));
  $("#penVal").textContent=moneyOut(p);
  $("#feeVal").textContent=moneyOut(f);
  $("#fareVal").textContent=moneyOut(d);
  $("#ppVal").textContent=moneyOut(p+f+d);
  $("#totVal").textContent=moneyOut((p+f+d)*pax);

  // Localizadores → chips
  const locs = ($("#bookingRef").value||"").trim();
  const ml   = ($("#maarlabRef").value||"").trim();
  const c = $("#locBadges"); c.innerHTML="";
  if(locs){ const b=document.createElement("span"); b.className="badge"; b.textContent=`PNR: ${locs}`; c.appendChild(b); }
  if(ml){ const b=document.createElement("span"); b.className="badge"; b.textContent=`Maarlab: ${ml}`; c.appendChild(b); }

  // Hotel opcional (nombre + logo)
  const hname = ($("#hotelNameInput").value||"").trim();
  const showLogo = !!hotelLogoData;
  $("#hotelName").textContent = hname || "—";
  $("#hotelBox").style.display = (hname || showLogo) ? "flex" : "none";
  const img = $("#hotelLogoImg");
  if(showLogo){ img.src = hotelLogoData; img.style.display="block"; } else { img.removeAttribute("src"); img.style.display="none"; }
}

/* Binds (en tiempo real robusto) */
function bindAll(){
  const rebind = ()=>{
    document.querySelectorAll("#panel input, #panel select").forEach(el=>{
      el.oninput = (e)=>{
        const isTime = /(Dep|Arr|StopArr|StopDep)$/i.test(el.id);
        const isIata = /(outFrom|outTo|retFrom|retTo|Stop)$/i.test(el.id);
        if(isIata) e.target.value = e.target.value.toUpperCase();
        if(isTime) e.target.classList.toggle("invalid", !!e.target.value && !/^([01]\d|2[0-3]):[0-5]\d$/.test(e.target.value));
        if(e.target.dataset.iata){
          const city=$(e.target.dataset.iata);
          const c=e.target.value.toUpperCase().trim();
          if(city && c.length>=3 && IATA_DB[c]) city.value=IATA_DB[c];
        }
        refresh();
      };
      el.onchange = refresh;
      el.onkeyup  = refresh; // redundancia para “tiempo real”
    });
  };
  rebind();

  // Hotel logo local
  $("#hotelLogoFile")?.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) { hotelLogoData=""; refresh(); return; }
    const r = new FileReader();
    r.onload = () => { hotelLogoData = r.result; refresh(); };
    r.readAsDataURL(f);
  });

  // Moneda
  $("#chipCurrency")?.addEventListener("click",(e)=>{
    const b=e.target.closest("button"); if(!b) return;
    CUR=b.dataset.cur;
    document.querySelectorAll("#chipCurrency button").forEach(x=>x.classList.toggle("active",x===b));
    if(CUR!=="EUR") $("#fxEnable").checked = true;
    refresh();
  });

  // Idioma
  $("#chipLang")?.addEventListener("click",(e)=>{
    const b=e.target.closest("button"); if(!b) return;
    LANG=b.dataset.lang;
    document.querySelectorAll("#chipLang button").forEach(x=>x.classList.toggle("active",x===b));
    applyI18n();
  });

  // Export
  const enable = ()=>{ const on=$("#ncAgree").checked; ["btnPng","btnPdf","btnPng2","btnPdf2"].forEach(id=>{ const b=$(id); if(b) b.disabled=!on; }); };
  $("#ncAgree")?.addEventListener("change", enable);
  enable();
  ["btnPng","btnPng2"].forEach(id=>$(id)&&$(id).addEventListener("click", exportPNG));
  ["btnPdf","btnPdf2"].forEach(id=>$(id)&&$(id).addEventListener("click", ()=>window.print()));

  // Defaults
  $("#airlineBase").value = DEFAULT_AIRLINE_BASE;
  $("#maarlabLogoM").src = DEFAULT_MAARLAB_MARK;

  // Datalists
  const dlAir = $("#airlineCodes"); dlAir.innerHTML="";
  Object.keys(AIRLINES).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.label=AIRLINES[k]; dlAir.appendChild(o); });
  const dlIata = $("#iataList"); dlIata.innerHTML="";
  Object.keys(IATA_DB).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.label=IATA_DB[k]; dlIata.appendChild(o); });

  // Primer render
  refresh();
}

/* Incrustar imágenes (bypass CORS para PNG) */
async function inlineImgs(root){
  const imgs = Array.from(root.querySelectorAll("img"));
  const original = [];
  for(const img of imgs){
    if(!img.src || img.src.startsWith("data:")) continue;
    original.push([img, img.src, img.style.visibility]);
    try{
      const res = await fetch(img.src, {mode:"cors", cache:"no-store"});
      if(!res.ok) throw new Error("fetch " + res.status);
      const blob = await res.blob();
      const r = new FileReader();
      const dataUrl = await new Promise(resolve=>{ r.onload=()=>resolve(r.result); r.readAsDataURL(blob); });
      img.setAttribute("data-inline-src", img.src);
      img.src = dataUrl;
    }catch(e){
      img.setAttribute("data-inline-failed","1");
      img.style.visibility="hidden";
    }
  }
  return ()=>{ for(const [img,src,vis] of original){ if(img.getAttribute("data-inline-src")) img.src=src; img.style.visibility=vis||""; img.removeAttribute("data-inline-src"); img.removeAttribute("data-inline-failed"); } };
}

/* Export PNG (solo el visualizador) */
async function exportPNG(){
  if(!$("#ncAgree").checked){ alert(STR[LANG].exportWarn); return; }
  try{
    const restore = await inlineImgs($("#exportArea"));
    const dataUrl = await htmlToImage.toPng($("#exportArea"), {pixelRatio:2, cacheBust:true});
    restore();
    const out=$("#outFrom").value||"XXX", to=$("#outTo").value||"XXX", r1=$("#retFrom").value||"XXX", r2=$("#retTo").value||"XXX";
    const when = $("#nrDate").value || $("#noDate").value || $("#orDate").value || $("#ooDate").value || "date";
    const a=document.createElement("a"); a.href=dataUrl; a.download=`${out}-${to}_${r1}-${r2}-${when}.png`.replace(/\s+/g,"_"); a.click();
  }catch(e){
    alert(STR[LANG].exportFail); console.error(e);
  }
}

/* Start */
document.addEventListener("DOMContentLoaded", ()=>{ bindAll(); applyI18n(); });
</script>
</body>
</html>
