<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cambio de vuelos · Maarlab</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --card:#fff; --ink:#0b2a5a; --sub:#475569; --border:#e2e8f0;
    --accent:#2bd9a7; --accent2:#40c8ff;
    --oldA:#ffe8ea; --oldB:#ffd2d7; --oldBorder:#c62828;
    --newA:#e7f7ee; --newB:#d1f1de; --newBorder:#15803d;
    --muted:#eef2f7;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font:15px/1.5 -apple-system,BlinkMacSystemFont,Inter,Roboto,"Segoe UI","Helvetica Neue",Arial,sans-serif;background:#fff}
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  body::after{content:"";position:fixed;inset:0;z-index:-1;background:linear-gradient(to bottom,rgba(255,255,255,.44),rgba(255,255,255,.66) 45%,rgba(255,255,255,.92))}
  .wrap{max-width:1240px;margin:0 auto;padding:16px}

  .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:30}
  .barInner{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1240px;margin:0 auto;padding:10px 16px}
  .brandChip{background:linear-gradient(135deg,var(--accent),var(--accent2));padding:6px 12px;border-radius:12px;display:inline-flex;align-items:center}
  .mlogoH{height:22px;display:block}
  .sep{height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2))}

  .grid2{display:grid;gap:16px}
  @media(min-width:1100px){.grid2{grid-template-columns:2fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px}
  .btn{border:0;border-radius:12px;padding:10px 14px;color:#0b2a5a;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .chip button{padding:6px 10px;border:0;background:#f1f5f9;cursor:pointer;color:#0b2a5a}
  .chip button.active{background:#fff}
  label{font-size:12px;color:#334155;display:block;margin-bottom:8px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#0b2a5a}
  input[placeholder]{text-transform:uppercase}
  input.invalid{border-color:#ef4444!important;background:#fff1f2}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .tiny{font-size:11px;color:#64748b}
  h2{font:700 16px/1.2 Poppins, system-ui; margin:0 0 6px}

  #exportArea{position:relative}
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px}
  #hdr-title{font:700 30px Poppins,system-ui}
  .logoBoxSq{width:48px;height:48px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoBoxSq img{max-width:100%;max-height:100%;object-fit:contain;display:block}

  .itins{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .itinCol{border:1px solid var(--border);border-radius:14px;padding:12px;min-height:300px}
  .itinOld{background:linear-gradient(180deg,var(--oldA),var(--oldB));border-color:var(--oldBorder)}
  .itinNew{background:linear-gradient(180deg,var(--newA),var(--newB));border-color:var(--newBorder)}
  .leg{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8;margin-top:10px}
  .legHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .codes{font-weight:700;font-size:18px}
  .airLogoBox{height:42px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;min-width:120px}
  .airLogoBox img{max-height:100%;width:auto;display:block}
  .meta{font-size:12px;color:#475569;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:3px 8px;font-size:11px;color:#334155}
  .times{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .times.stop{grid-template-columns:repeat(4,1fr)}
  .big{font-weight:700;font-size:18px}
  .dim{font-size:12px;color:#334155;margin-top:6px}
  .prices{display:grid;grid-template-columns:repeat(4,1fr) 1.2fr;gap:12px;margin-top:14px}
  .pill{border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;background:var(--muted)}
  .pill .v{font-weight:700}
  .totalPill{background:linear-gradient(135deg,#e7f3ff,#ecfbff);border-color:#93c5fd}
  .totalPill .v{font-size:22px}
  .notes{margin-top:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px;min-height:60px}
  .foot{display:flex;justify-content:space-between;gap:12px;margin-top:12px;color:#64748b;font-size:12px;align-items:center}
  .hotelBox{display:none;align-items:center;justify-content:space-between;gap:10px;margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8}
  .hotelLogo{width:56px;height:56px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .hotelLogo img{max-width:100%;max-height:100%;object-fit:contain}

  @media print{
    .bar,.sep,#panel,.btnPdfHide{display:none!important}
    *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
    @page{size:A4 landscape;margin:10mm}
  }
  #err{display:none;background:#fff4f4;border:1px solid #fecaca;color:#7f1d1d;padding:8px;border-radius:10px;margin:10px 0;font-size:13px}
</style>
</head>
<body>
  <div class="bar">
    <div class="barInner">
      <span class="brandChip">
        <img class="mlogoH" alt="Maarlab" src="https://maarlab.com/wp-content/uploads/2024/09/maarlab-footer.svg" crossorigin="anonymous" referrerpolicy="no-referrer">
      </span>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="chip" id="chipLang">
          <button data-lang="es" class="active">ES</button><button data-lang="en">EN</button><button data-lang="fr">FR</button><button data-lang="it">IT</button><button data-lang="de">DE</button>
        </div>
        <div class="chip" id="chipCurrency">
          <button data-cur="EUR" class="active">EUR</button><button data-cur="USD">USD</button><button data-cur="MXN">MXN</button>
        </div>
      </div>
    </div>
    <div class="sep"></div>
  </div>

  <main class="wrap grid2">
    <!-- ===== Visualizador ===== -->
    <section class="card" id="cardWrap">
      <div id="err"></div>
      <div id="exportArea">
        <div class="headerRow">
          <div>
            <div class="tiny" id="hdr-sub">Cambio de vuelos · Round Trip</div>
            <div id="hdr-title">Cambio de vuelos</div>
            <div class="tiny" id="hdr-dates">Ida: — → — · Vuelta: — → —</div>
            <div class="badges" id="locBadges"></div>
          </div>
          <div class="logoBoxSq"><img id="maarlabLogoM" alt="M" src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
        </div>

        <div class="itins">
          <div class="itinCol itinOld">
            <div style="font:700 14px Poppins,system-ui" id="prevTitle">Itinerario anterior</div>
            <div class="leg" id="leg-oo">
              <div class="legHead">
                <div><div class="codes" id="ooCodes">XXX → XXX</div><div class="tiny" id="ooCities">— → —</div></div>
                <div class="airLogoBox"><img id="logo-oo" alt="air-oo" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="ooMeta">Vuelo — Fecha</span><div class="badges" id="ooBadges"></div></div>
              <div class="times" id="ooTimes"></div><div class="dim" id="ooDur">Duración: —</div>
            </div>
            <div class="leg" id="leg-or">
              <div class="legHead">
                <div><div class="codes" id="orCodes">XXX → XXX</div><div class="tiny" id="orCities">— → —</div></div>
                <div class="airLogoBox"><img id="logo-or" alt="air-or" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="orMeta">Vuelo — Fecha</span><div class="badges" id="orBadges"></div></div>
              <div class="times" id="orTimes"></div><div class="dim" id="orDur">Duración: —</div>
            </div>
          </div>

          <div class="itinCol itinNew">
            <div style="font:700 14px Poppins,system-ui" id="newTitle">Itinerario nuevo</div>
            <div class="leg" id="leg-no">
              <div class="legHead">
                <div><div class="codes" id="noCodes">XXX → XXX</div><div class="tiny" id="noCities">— → —</div></div>
                <div class="airLogoBox"><img id="logo-no" alt="air-no" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="noMeta">Vuelo — Fecha</span><div class="badges" id="noBadges"></div></div>
              <div class="times" id="noTimes"></div><div class="dim" id="noDur">Duración: —</div>
            </div>
            <div class="leg" id="leg-nr">
              <div class="legHead">
                <div><div class="codes" id="nrCodes">XXX → XXX</div><div class="tiny" id="nrCities">— → —</div></div>
                <div class="airLogoBox"><img id="logo-nr" alt="air-nr" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="nrMeta">Vuelo — Fecha</span><div class="badges" id="nrBadges"></div></div>
              <div class="times" id="nrTimes"></div><div class="dim" id="nrDur">Duración: —</div>
            </div>
          </div>
        </div>

        <div class="hotelBox" id="hotelBox">
          <div><div class="tiny" id="hotelCaption">Hotel</div><div class="big" id="hotelName">—</div></div>
          <div class="hotelLogo"><img id="hotelLogoImg" alt="hotel-logo"></div>
        </div>

        <div class="prices">
          <div class="pill"><div class="tiny" id="penLabel">Penalización</div><div class="v" id="penVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="feeLabel">Fee servicio</div><div class="v" id="feeVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="fareLabel">Diferencia de tarifa</div><div class="v" id="fareVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="ppLabel">Total por pax</div><div class="v" id="ppVal">€0,00</div></div>
          <div class="pill totalPill"><div class="tiny" id="totLabel">Total a pagar</div><div class="v" id="totVal">€0,00</div></div>
        </div>

        <div class="notes" contenteditable="true" id="notesBox">Notas / Notes…</div>
      </div>

      <div class="foot">
        <div class="tiny" id="footerText">Generado por Maarlab · Contacto: booking@maarlab.com</div>
        <div class="btnPdfHide" style="display:flex;gap:8px">
          <button id="btnPng" class="btn" disabled>PNG</button>
          <button id="btnPdf" class="btn" disabled>PDF</button>
        </div>
      </div>
    </section>

    <!-- ===== Formulario ===== -->
    <aside class="card" id="panel">
      <h2 id="hOut">Ruta (ida)</h2>
      <div class="row">
        <label>Origen (IATA) <input id="outFrom" list="iataList" placeholder="TFN" data-iata="outFromCity"></label>
        <label>Ciudad origen <input id="outFromCity" placeholder="Tenerife Norte"></label>
        <label>Destino (IATA) <input id="outTo" list="iataList" placeholder="MAD" data-iata="outToCity"></label>
        <label>Ciudad destino <input id="outToCity" placeholder="Madrid"></label>
      </div>

      <h2 id="hRet" style="margin-top:12px">Ruta (vuelta)</h2>
      <div class="row">
        <label>Origen (IATA) <input id="retFrom" list="iataList" placeholder="MAD" data-iata="retFromCity"></label>
        <label>Ciudad origen <input id="retFromCity" placeholder="Madrid"></label>
        <label>Destino (IATA) <input id="retTo" list="iataList" placeholder="TFN" data-iata="retToCity"></label>
        <label>Ciudad destino <input id="retToCity" placeholder="Tenerife Norte"></label>
      </div>

      <h2 style="margin-top:14px">Itinerario anterior</h2>
      <div class="row">
        <label>Ida — Aerolínea (código) <input id="ooAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label>Ida — N.º vuelo <input id="ooNum" placeholder="3478"></label>
        <label>Ida — Salida <input id="ooDep" placeholder="10:30"></label>
        <label>Ida — Llegada <input id="ooArr" placeholder="12:50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Vuelta — Aerolínea (código) <input id="orAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label>Vuelta — N.º vuelo <input id="orNum" placeholder="3479"></label>
        <label>Vuelta — Salida <input id="orDep" placeholder="17:20"></label>
        <label>Vuelta — Llegada <input id="orArr" placeholder="19:35"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Ida — Fecha <input id="ooDate" type="date"></label>
        <label>Vuelta — Fecha <input id="orDate" type="date"></label>
      </div>

      <h2 style="margin-top:14px">Itinerario nuevo</h2>
      <div class="row">
        <label>Ida — Aerolínea (código) <input id="noAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label>Ida — N.º vuelo <input id="noNum" placeholder="1234"></label>
        <label>Ida — Salida <input id="noDep" placeholder="11:15"></label>
        <label>Ida — Llegada <input id="noArr" placeholder="13:40"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Vuelta — Aerolínea (código) <input id="nrAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label>Vuelta — N.º vuelo <input id="nrNum" placeholder="1235"></label>
        <label>Vuelta — Salida <input id="nrDep" placeholder="18:10"></label>
        <label>Vuelta — Llegada <input id="nrArr" placeholder="20:30"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Ida — Fecha <input id="noDate" type="date"></label>
        <label>Vuelta — Fecha <input id="nrDate" type="date"></label>
      </div>

      <details style="margin-top:8px">
        <summary>Escalas (opcionales)</summary>
        <div class="row" style="margin-top:8px">
          <label>Old Out — Stop (IATA) <input id="ooStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="ooStopArr" placeholder="11:20"></label>
          <label>Depart stop (HH:MM) <input id="ooStopDep" placeholder="12:05"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>Old Ret — Stop (IATA) <input id="orStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="orStopArr" placeholder="18:05"></label>
          <label>Depart stop (HH:MM) <input id="orStopDep" placeholder="18:50"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>New Out — Stop (IATA) <input id="noStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="noStopArr" placeholder="12:00"></label>
          <label>Depart stop (HH:MM) <input id="noStopDep" placeholder="12:45"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>New Ret — Stop (IATA) <input id="nrStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="nrStopArr" placeholder="21:00"></label>
          <label>Depart stop (HH:MM) <input id="nrStopDep" placeholder="21:40"></label>
          <div></div>
        </div>
      </details>

      <h2 style="margin-top:14px">Hotel (opcional)</h2>
      <div class="row">
        <label>Nombre de hotel <input id="hotelNameInput" placeholder="Spring Arona Gran"></label>
        <label>Logo del hotel (archivo) <input id="hotelLogoFile" type="file" accept="image/*"></label>
      </div>

      <h2 style="margin-top:14px">Localizadores (opcional)</h2>
      <div class="row">
        <label>Localizador reserva <input id="bookingRef" placeholder="ABC123"></label>
        <label>Localizador Maarlab <input id="maarlabRef" placeholder="MLB-0001"></label>
      </div>

      <h2 style="margin-top:14px">Costes</h2>
      <div class="row-3">
        <label>Penalización <input id="penalty" placeholder="150,00"></label>
        <label>Fee servicio <input id="fee" placeholder="30,00"></label>
        <label>Diferencia de tarifa <input id="fareDiff" placeholder="45,50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Pax <input id="pax" type="number" min="1" step="1" value="1"></label><div></div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="ncAgree"><span class="tiny">Confirmo uso informativo y no comercial. Se puede exportar/capturar.</span>
        </label>
        <div style="flex:1"></div>
        <button id="btnPng2" class="btn" disabled>PNG</button>
        <button id="btnPdf2" class="btn" disabled>PDF</button>
      </div>

      <details style="margin-top:12px">
        <summary>Opciones avanzadas</summary>
        <div class="row" style="margin-top:8px">
          <label>Logos aerolíneas (base URL) <input id="airlineBase"></label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="fxEnable" checked> <span>Convertir desde EUR</span>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>1 EUR = USD <input id="fxUSD" value="1.08"></label>
          <label>1 EUR = MXN <input id="fxMXN" value="19.00"></label>
        </div>
      </details>
    </aside>
  </main>

  <datalist id="airlineCodes"></datalist>
  <datalist id="iataList"></datalist>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
(function(){
  var $ = function(id){ return document.getElementById(id); };
  var ICON_DEP = "https://cdn-icons-png.flaticon.com/512/565/565514.png";
  var ICON_ARR = "https://www.svgrepo.com/show/352351/plane-arrival.svg";

  var STR = {
    es:{hdrSub:"Cambio de vuelos · Round Trip",hdrTitle:"Cambio de vuelos",dep:"Salida",arr:"Llegada",
        arrStop:"Llegada escala",depStop:"Salida escala",duration:"Duración",layover:"Escala",
        prev:"Itinerario anterior",next:"Itinerario nuevo",
        footer:"Generado por Maarlab · Contacto: booking@maarlab.com",
        exportWarn:"Confirma uso no comercial.", exportFail:"No se pudo exportar (CORS).",
        badges:{plusDays:"+{n} día(s)", tz:"ΔTZ {h}h", dst:"DST", odd:"Duración inusual"}},
    en:{hdrSub:"Flight change · Round Trip",hdrTitle:"Flight change",dep:"Departure",arr:"Arrival",
        arrStop:"Arrive stop",depStop:"Depart stop",duration:"Duration",layover:"Layover",
        prev:"Previous itinerary",next:"New itinerary",
        footer:"Generated by Maarlab · Contact: booking@maarlab.com",
        exportWarn:"Please confirm non-commercial use.", exportFail:"Export failed (CORS).",
        badges:{plusDays:"+{n} day(s)", tz:"ΔTZ {h}h", dst:"DST", odd:"Odd duration"}},
    fr:{hdrSub:"Changement de vols · AR",hdrTitle:"Changement de vols",dep:"Départ",arr:"Arrivée",
        arrStop:"Arrivée escale",depStop:"Départ escale",duration:"Durée",layover:"Escale",
        prev:"Itinéraire précédent",next:"Nouvel itinéraire",
        footer:"Généré par Maarlab · Contact : booking@maarlab.com",
        exportWarn:"Confirmez l’usage non commercial.", exportFail:"Échec d’export (CORS).",
        badges:{plusDays:"+{n} jour(s)", tz:"ΔTZ {h}h", dst:"Heure d'été", odd:"Durée inhabituelle"}},
    it:{hdrSub:"Cambio voli · A/R",hdrTitle:"Cambio voli",dep:"Partenza",arr:"Arrivo",
        arrStop:"Arrivo scalo",depStop:"Partenza scalo",duration:"Durata",layover:"Scalo",
        prev:"Itinerario precedente",next:"Nuovo itinerario",
        footer:"Generato da Maarlab · Contatto: booking@maarlab.com",
        exportWarn:"Conferma uso non commerciale.", exportFail:"Export fallito (CORS).",
        badges:{plusDays:"+{n} giorno/i", tz:"ΔTZ {h}h", dst:"Ora legale", odd:"Durata insolita"}},
    de:{hdrSub:"Flugänderung · RT",hdrTitle:"Flugänderung",dep:"Abflug",arr:"Ankunft",
        arrStop:"Ankunft Zwischenstopp",depStop:"Abflug Zwischenstopp",duration:"Dauer",layover:"Zwischenstopp",
        prev:"Bisherige Reiseroute",next:"Neue Reiseroute",
        footer:"Erstellt von Maarlab · Kontakt: booking@maarlab.com",
        exportWarn:"Bitte nicht-kommerziellen Nutzen bestätigen.", exportFail:"Export fehlgeschlagen (CORS).",
        badges:{plusDays:"+{n} Tag(e)", tz:"ΔTZ {h}h", dst:"Sommerzeit", odd:"Ungewöhnliche Dauer"}}
  };
  var LANG="es", CUR="EUR";

  var DEFAULT_AIRLINE_BASE = "https://maarlabcdnstorage.blob.core.windows.net/web-assets/images/airlines";
  var DEFAULT_MAARLAB_MARK = "https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg";

  var AIRLINES = {"U":"easyJet","U2":"easyJet","AM":"Aeroméxico","Y4":"Volaris","VB":"VivaAerobus",
    "IB":"Iberia","I2":"Iberia Express","VY":"Vueling","UX":"Air Europa","NT":"Binter Canarias","FR":"Ryanair",
    "F8":"Frontier","F9":"Frontier","AA":"American Airlines","UA":"United","DL":"Delta","B6":"JetBlue","WN":"Southwest","NK":"Spirit",
    "BA":"British Airways","KL":"KLM","AF":"Air France","LH":"Lufthansa","LX":"SWISS","OS":"Austrian","SN":"Brussels Airlines",
    "QR":"Qatar","EK":"Emirates","EY":"Etihad","W6":"Wizz Air","W4":"Wizz Air Malta"
  };
  var LOGO_FALLBACK = {"F8":"F9","U":"U2"};

  var IATA_DB = {"MAD":"Madrid","TFN":"Tenerife Norte","TFS":"Tenerife Sur","BCN":"Barcelona","LIS":"Lisboa","MEX":"Ciudad de México",
    "CUN":"Cancún","TQO":"Tulum (Felipe Carrillo Puerto)","CZM":"Cozumel","HUX":"Huatulco","PVR":"Puerto Vallarta","ACA":"Acapulco",
    "DFW":"Dallas/Fort Worth","EWR":"Newark","LHR":"Londres (Heathrow)","LGW":"Londres (Gatwick)","LAX":"Los Ángeles","SFO":"San Francisco",
    "PMI":"Palma","IBZ":"Ibiza","ALC":"Alicante","SVQ":"Sevilla","VLC":"Valencia","FRA":"Fráncfort","CDG":"París (CDG)"
  };
  var TZ_DB = {"MAD":"Europe/Madrid","TFN":"Atlantic/Canary","TFS":"Atlantic/Canary","BCN":"Europe/Madrid","LIS":"Europe/Lisbon",
               "MEX":"America/Mexico_City","CUN":"America/Cancun","TQO":"America/Cancun","CZM":"America/Cancun","HUX":"America/Mexico_City",
               "PVR":"America/Mexico_City","ACA":"America/Mexico_City","DFW":"America/Chicago","EWR":"America/New_York",
               "LHR":"Europe/London","LGW":"Europe/London","LAX":"America/Los_Angeles","SFO":"America/Los_Angeles","CDG":"Europe/Paris","FRA":"Europe/Berlin"};

  var DateTime = luxon.DateTime;
  var hotelLogoData = "";

  function showErr(msg){
    var e=$("err"); e.textContent=msg; e.style.display="block";
    setTimeout(function(){ e.style.display="none"; },4000);
  }
  function nf(cur,lang){
    var loc = lang==="en"?"en-US":lang==="fr"?"fr-FR":lang==="it"?"it-IT":lang==="de"?"de-DE":"es-ES";
    return new Intl.NumberFormat(loc,{style:"currency",currency:cur,minimumFractionDigits:2,maximumFractionDigits:2});
  }
  function parseMoney(s){ var t=String(s||"").replace(/\./g,"").replace(",","."); var n=parseFloat(t); return isFinite(n)?n:0; }
  function normalizeCode(c){ return String(c||"").toUpperCase(); }
  function airlineLogoUrl(code){
    var base = ($("airlineBase") && $("airlineBase").value) ? $("airlineBase").value : DEFAULT_AIRLINE_BASE;
    return base.replace(/\/$/,"") + "/" + code + ".png";
  }
  function fmtDate(d){
    if(!d) return "—";
    var parts = String(d).split("-");
    if(parts.length!==3) return d;
    return parts[2]+"/"+parts[1]+"/"+parts[0];
  }
  var HM_RE = /^([01]\d|2[0-3]):[0-5]\d$/;

  function dayOfWeek(dateISO){
    if(!dateISO) return "";
    var loc = {es:"es",en:"en",fr:"fr",it:"it",de:"de"}[LANG]||"es";
    try{ return DateTime.fromISO(dateISO).setLocale(loc).toFormat("cccc"); }catch(e){ return ""; }
  }
  function zonedDT(dateISO, hm, iata){
    if(!dateISO || !HM_RE.test(hm) || !iata) return null;
    var zone = TZ_DB[normalizeCode(iata)] || "UTC";
    return DateTime.fromISO(dateISO+"T"+hm,{zone:zone});
  }
  function segmentMinutes(dateISO, depHM, arrHM, fromIata, toIata){
    try{
      var dep = zonedDT(dateISO, depHM, fromIata);
      var arr = zonedDT(dateISO, arrHM, toIata);
      if(!dep || !arr) return NaN;
      var diff = arr.toUTC().diff(dep.toUTC(), "minutes").minutes;
      while(diff<0) diff+=1440;
      return diff;
    }catch(e){ return NaN; }
  }
  function layoverMinutes(dateISO, arrHM, depHM, stopIata){
    try{
      var a = zonedDT(dateISO, arrHM, stopIata), d = zonedDT(dateISO, depHM, stopIata);
      if(!a || !d) return NaN;
      var diff = d.diff(a,"minutes").minutes;
      while(diff<0) diff+=1440;
      return diff;
    }catch(e){ return NaN; }
  }
  function fmtHM(m){
    if(!isFinite(m)) return "—";
    m=Math.abs(Math.round(m));
    return Math.floor(m/60)+"h "+(m%60)+"m";
  }

  function moneyOut(v){
    var fxOn = $("fxEnable") && $("fxEnable").checked;
    if(CUR==="EUR") return nf("EUR",LANG).format(v);
    if(!fxOn) return nf(CUR,LANG).format(v);
    var usd = Number(($("fxUSD")&&$("fxUSD").value)||1.08);
    var mxn = Number(($("fxMXN")&&$("fxMXN").value)||19.0);
    if(CUR==="USD") return nf("USD",LANG).format(v*usd);
    if(CUR==="MXN") return nf("MXN",LANG).format(v*mxn);
    return nf(CUR,LANG).format(v);
  }

  function applyI18n(){
    var S=STR[LANG];
    $("hdr-sub").textContent=S.hdrSub;
    $("hdr-title").textContent=S.hdrTitle;
    $("prevTitle").textContent=S.prev;
    $("newTitle").textContent=S.next;
    $("footerText").textContent=S.footer;
    refresh();
  }

  function buildBadges(dateISO, depHM, arrHM, fromIata, toIata){
    var S=STR[LANG].badges, out=[];
    try{
      var dep=zonedDT(dateISO,depHM,fromIata), arr=zonedDT(dateISO,arrHM,toIata);
      if(!dep||!arr) return out;
      var depLocal=dep.setZone(TZ_DB[fromIata]||dep.zoneName);
      var arrLocal=arr.setZone(TZ_DB[toIata]||arr.zoneName);
      var plusDays = Math.floor(arrLocal.startOf("day").diff(depLocal.startOf("day"),"days").days);
      if(plusDays>0) out.push(S.plusDays.replace("{n}",plusDays));
      var deltaH=(arr.offset-dep.offset)/60; if(deltaH!==0) out.push(S.tz.replace("{h}",(deltaH>0?"+":"")+deltaH));
      if(dep.zoneName===arr.zoneName && dep.offset!==arr.offset) out.push(S.dst);
      var m=segmentMinutes(dateISO,depHM,arrHM,fromIata,toIata);
      if(isFinite(m) && (m<30||m>960)) out.push(S.odd);
    }catch(e){}
    return out;
  }

  function setLegLogo(imgId, code){
    var img=$(imgId); if(!img) return;
    var raw=normalizeCode(code);
    if(!raw){ img.style.visibility="hidden"; img.removeAttribute("src"); return; }
    var fallback = LOGO_FALLBACK[raw] ? normalizeCode(LOGO_FALLBACK[raw]) : "";
    img.style.visibility="visible"; img.onerror=null;
    img.onerror=function(){
      if(fallback && img.getAttribute("data-fb")!=="1"){
        img.setAttribute("data-fb","1"); img.src=airlineLogoUrl(fallback);
      }else{ img.style.visibility="hidden"; img.removeAttribute("src"); }
    };
    img.crossOrigin="anonymous"; img.referrerPolicy="no-referrer";
    img.removeAttribute("data-fb");
    img.src=airlineLogoUrl(raw);
  }

  function renderLeg(prefix, fromIata, toIata, cityFrom, cityTo){
    var S=STR[LANG];
    var code=normalizeCode($(prefix+"Air").value);
    var num=(($(prefix+"Num").value)||"").toUpperCase();
    var dateISO = (prefix==="oo"||prefix==="or") ? ($(prefix==="oo"?"ooDate":"orDate").value) : ($(prefix==="no"?"noDate":"nrDate").value);
    var dow = dayOfWeek(dateISO);
    var stop=normalizeCode((($(prefix+"Stop")||{}).value)||"");
    var stopArr=(($(prefix+"StopArr")||{}).value)||"";
    var stopDep=(($(prefix+"StopDep")||{}).value)||"";

    $(prefix+"Codes").textContent = (fromIata||"XXX")+" → "+(toIata||"XXX");
    $(prefix+"Cities").textContent = (cityFrom||"—")+" → "+(cityTo||"—");
    var dateTxt = dateISO? (dow+" "+fmtDate(dateISO)) : "—";
    $(prefix+"Meta").textContent = (code||"")+(num||"")+" · "+(AIRLINES[code]||"—")+" · "+dateTxt;
    setLegLogo("logo-"+prefix, code);

    var $b=$(prefix+"Badges"); $b.innerHTML="";
    var bs = buildBadges(dateISO, $(prefix+"Dep").value, $(prefix+"Arr").value, fromIata, toIata);
    for(var i=0;i<bs.length;i++){ var sp=document.createElement("span"); sp.className="badge"; sp.textContent=bs[i]; $b.appendChild(sp); }

    var $t=$(prefix+"Times"); $t.innerHTML="";
    function cell(lbl,val,kind){
      var w=document.createElement("div");
      var l=document.createElement("div"); l.className="tiny";
      var ic=document.createElement("img"); ic.className="icon"; ic.alt=kind||""; ic.crossOrigin="anonymous"; ic.referrerPolicy="no-referrer";
      ic.src=(kind==="dep"||kind==="depStop")?ICON_DEP:ICON_ARR;
      l.appendChild(ic); l.appendChild(document.createTextNode(lbl));
      var v=document.createElement("div"); v.className="big"; v.textContent=val||"--:--";
      w.appendChild(l); w.appendChild(v); return w;
    }
    var depHM=$(prefix+"Dep").value, arrHM=$(prefix+"Arr").value;
    var totalM=NaN, layM=NaN;
    if(stop && HM_RE.test(stopArr||"") && HM_RE.test(stopDep||"")){
      $t.classList.add("stop");
      $t.appendChild(cell(S.dep,depHM,"dep"));
      $t.appendChild(cell(S.arrStop,stopArr,"arrStop"));
      $t.appendChild(cell(S.depStop,stopDep,"depStop"));
      $t.appendChild(cell(S.arr,arrHM,"arr"));
      var s1=segmentMinutes(dateISO,depHM,stopArr,fromIata,stop);
      var s2=segmentMinutes(dateISO,stopDep,arrHM,stop,toIata);
      layM=layoverMinutes(dateISO,stopArr,stopDep,stop);
      totalM=(isFinite(s1)?s1:0)+(isFinite(s2)?s2:0);
    }else{
      $t.classList.remove("stop");
      $t.appendChild(cell(S.dep,depHM,"dep"));
      $t.appendChild(cell(S.arr,arrHM,"arr"));
      totalM=segmentMinutes(dateISO,depHM,arrHM,fromIata,toIata);
    }
    $(prefix+"Dur").textContent = S.duration+": "+(isFinite(totalM)?fmtHM(totalM):"—")+(isFinite(layM)?(" · "+S.layover+": "+fmtHM(layM)):"");
  }

  function refresh(){
    try{
      var outFrom=normalizeCode(($("outFrom").value)||"XXX"), outTo=normalizeCode(($("outTo").value)||"XXX");
      var retFrom=normalizeCode(($("retFrom").value)||"XXX"), retTo=normalizeCode(($("retTo").value)||"XXX");
      var outFromCity=($("outFromCity").value)||"—", outToCity=($("outToCity").value)||"—";
      var retFromCity=($("retFromCity").value)||"—", retToCity=($("retToCity").value)||"—";

      var ood=fmtDate(($("ooDate").value)||""), ord=fmtDate(($("orDate").value)||""), nod=fmtDate(($("noDate").value)||""), nrd=fmtDate(($("nrDate").value)||"");
      var oodD=dayOfWeek(($("ooDate").value)||""), ordD=dayOfWeek(($("orDate").value)||""), nodD=dayOfWeek(($("noDate").value)||""), nrdD=dayOfWeek(($("nrDate").value)||"");

      $("hdr-dates").textContent = "Ida: "+(oodD?oodD+" ":"")+ood+" → "+(nodD?nodD+" ":"")+nod+" · Vuelta: "+(ordD?ordD+" ":"")+ord+" → "+(nrdD?nrdD+" ":"")+nrd;

      renderLeg("oo", outFrom, outTo, outFromCity, outToCity);
      renderLeg("or", retFrom, retTo, retFromCity, retToCity);
      renderLeg("no", outFrom, outTo, outFromCity, outToCity);
      renderLeg("nr", retFrom, retTo, retFromCity, retToCity);

      var p=parseMoney(($("penalty").value)||0), f=parseMoney(($("fee").value)||0), d=parseMoney(($("fareDiff").value)||0);
      var pax = Math.max(1, parseInt((($("pax").value)||"1"),10)||1);
      $("penVal").textContent=moneyOut(p);
      $("feeVal").textContent=moneyOut(f);
      $("fareVal").textContent=moneyOut(d);
      $("ppVal").textContent=moneyOut(p+f+d);
      $("totVal").textContent=moneyOut((p+f+d)*pax);

      var locs=(($("bookingRef").value)||"").trim(), ml=(($("maarlabRef").value)||"").trim();
      var c=$("locBadges"); c.innerHTML="";
      if(locs){ var b=document.createElement("span"); b.className="badge"; b.textContent="PNR: "+locs; c.appendChild(b); }
      if(ml){ var b2=document.createElement("span"); b2.className="badge"; b2.textContent="Maarlab: "+ml; c.appendChild(b2); }

      var hname=(($("hotelNameInput").value)||"").trim();
      $("hotelName").textContent = hname || "—";
      $("hotelBox").style.display = (hname || hotelLogoData) ? "flex" : "none";
      if(hotelLogoData){ $("hotelLogoImg").src = hotelLogoData; $("hotelLogoImg").style.display="block"; }
      else { $("hotelLogoImg").removeAttribute("src"); $("hotelLogoImg").style.display="none"; }
    }catch(e){ console.error(e); showErr("⚠️ Error de refresco: "+e.message); }
  }

  function bindAll(){
    // Enlaza TODOS los inputs para tiempo real
    var inputs = document.querySelectorAll("#panel input, #panel select");
    for(var i=0;i<inputs.length;i++){
      (function(el){
        el.addEventListener("input", function(e){
          // Uppercase IATA
          if(/(outFrom|outTo|retFrom|retTo|Stop)$/i.test(el.id)){ el.value = el.value.toUpperCase(); }
          // Validación HH:MM
          if(/(Dep|Arr|StopArr|StopDep)$/i.test(el.id)){
            var ok = (!el.value) || HM_RE.test(el.value);
            if(!ok) el.classList.add("invalid"); else el.classList.remove("invalid");
          }
          // Autocompletar ciudad desde IATA
          var targetId = el.getAttribute("data-iata");
          if(targetId){
            var cityEl=$(targetId), c=el.value.toUpperCase().trim();
            if(cityEl && c.length>=3 && IATA_DB[c]) cityEl.value = IATA_DB[c];
          }
          refresh();
        });
        el.addEventListener("change", refresh);
        el.addEventListener("keyup", refresh);
      })(inputs[i]);
    }

    // Hotel logo por archivo
    if($("hotelLogoFile")){
      $("hotelLogoFile").addEventListener("change", function(e){
        var f = e.target.files && e.target.files[0];
        if(!f){ hotelLogoData=""; refresh(); return; }
        var r=new FileReader(); r.onload=function(){ hotelLogoData = r.result; refresh(); }; r.readAsDataURL(f);
      });
    }

    // Idioma
    if($("chipLang")){
      $("chipLang").addEventListener("click", function(e){
        var b=e.target.closest("button"); if(!b) return;
        LANG = b.getAttribute("data-lang");
        var btns = $("chipLang").querySelectorAll("button"); for(var i=0;i<btns.length;i++){ btns[i].classList.toggle("active", btns[i]===b); }
        applyI18n();
      });
    }

    // Moneda
    if($("chipCurrency")){
      $("chipCurrency").addEventListener("click", function(e){
        var b=e.target.closest("button"); if(!b) return;
        CUR = b.getAttribute("data-cur");
        var btns = $("chipCurrency").querySelectorAll("button"); for(var i=0;i<btns.length;i++){ btns[i].classList.toggle("active", btns[i]===b); }
        refresh();
      });
    }

    // Export habilitación
    function toggleExport(){
      var on = $("ncAgree") && $("ncAgree").checked;
      ["btnPng","btnPdf","btnPng2","btnPdf2"].forEach(function(id){ if($(id)) $(id).disabled = !on; });
    }
    if($("ncAgree")) $("ncAgree").addEventListener("change", toggleExport);
    toggleExport();

    // Botones export
    var pngButtons=["btnPng","btnPng2"];
    for(var j=0;j<pngButtons.length;j++){ var id=pngButtons[j]; if($(id)) $(id).addEventListener("click", exportPNG); }
    var pdfButtons=["btnPdf","btnPdf2"];
    for(var k=0;k<pdfButtons.length;k++){ var id2=pdfButtons[k]; if($(id2)) $(id2).addEventListener("click", function(){ window.print(); }); }

    // Defaults
    if($("airlineBase")) $("airlineBase").value = DEFAULT_AIRLINE_BASE;
    if($("maarlabLogoM")) $("maarlabLogoM").src = DEFAULT_MAARLAB_MARK;

    // Datalists
    var dlAir=$("airlineCodes"); if(dlAir){ dlAir.innerHTML=""; Object.keys(AIRLINES).forEach(function(k){ var o=document.createElement("option"); o.value=k; o.label=AIRLINES[k]; dlAir.appendChild(o); }); }
    var dlI=$("iataList"); if(dlI){ dlI.innerHTML=""; Object.keys(IATA_DB).forEach(function(k){ var o=document.createElement("option"); o.value=k; o.label=IATA_DB[k]; dlI.appendChild(o); }); }
  }

  async function inlineImgs(root){
    var imgs = root.querySelectorAll("img"); var original=[];
    for(var i=0;i<imgs.length;i++){
      var img=imgs[i];
      if(!img.src || img.src.indexOf("data:")===0) continue;
      original.push([img,img.src,img.style.visibility]);
      try{
        var res = await fetch(img.src,{mode:"cors",cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        var blob = await res.blob();
        var r = new FileReader();
        var dataUrl = await new Promise(function(resolve){ r.onload=function(){ resolve(r.result); }; r.readAsDataURL(blob); });
        img.setAttribute("data-inline-src", img.src);
        img.src=dataUrl;
      }catch(e){
        img.setAttribute("data-inline-failed","1"); img.style.visibility="hidden";
      }
    }
    return function(){ for(var j=0;j<original.length;j++){ var tup=original[j]; var im=tup[0]; im.src=tup[1]; im.style.visibility=tup[2]||""; im.removeAttribute("data-inline-src"); im.removeAttribute("data-inline-failed"); } };
  }

  async function exportPNG(){
    if(!$("ncAgree") || !$("ncAgree").checked){ alert(STR[LANG].exportWarn); return; }
    try{
      var restore = await inlineImgs($("exportArea"));
      var dataUrl = await htmlToImage.toPng($("exportArea"), {pixelRatio:2, cacheBust:true});
      restore();
      var out=($("outFrom").value)||"XXX", to=($("outTo").value)||"XXX", r1=($("retFrom").value)||"XXX", r2=($("retTo").value)||"XXX";
      var when = ($("nrDate").value)||($("noDate").value)||($("orDate").value)||($("ooDate").value)||"date";
      var a=document.createElement("a"); a.href=dataUrl; a.download=(out+"-"+to+"_"+r1+"-"+r2+"-"+when+".png").replace(/\s+/g,"_"); a.click();
    }catch(e){ alert(STR[LANG].exportFail); console.error(e); }
  }

  document.addEventListener("DOMContentLoaded", function(){
    try{
      bindAll();
      applyI18n();
      refresh(); // primer pintado para que la tarjeta se vea ya
    }catch(e){ console.error(e); showErr("⚠️ Error inicializando: "+e.message); }
  });
})();
</script>
</body>
</html>
