<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Maarlab — Visualizador de Cambios RT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --ink:#0b2a5a; --sub:#475569;
    --accent:#2bd9a7; --accent2:#40c8ff; --border:#e2e8f0;
    --old:#fff5f5; --new:#ecfdf5; --muted:#eef2f7;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto}
  h1{font:700 22px/1.2 Poppins;margin:0}
  h2{font:700 16px/1.2 Poppins;margin:0 0 6px}
  .wrap{max-width:1240px;margin:0 auto;padding:16px}
  .bar{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:20}
  .flex{display:flex;gap:12px;align-items:center}
  .grow{flex:1}
  .btn{border:0;border-radius:12px;padding:10px 14px;color:#0b2a5a;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .chip button{padding:6px 10px;border:0;background:#f1f5f9;cursor:pointer;color:#0b2a5a}
  .chip button.active{background:#fff}
  .grid{display:grid;gap:16px}
  @media(min-width:1240px){.grid{grid-template-columns:470px 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px}
  label{font-size:12px;color:#334155;display:block;margin-bottom:8px}
  input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#0b2a5a}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .band{position:absolute;inset:0 0 auto 0;height:4px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .logos{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .logoBox{height:78px;padding:8px 14px;border:1px solid var(--border);border-radius:16px;background:#fff;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;max-width:340px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .logoBox img{max-height:100%;width:auto;display:block}
  .logoBoxSq{width:68px;height:68px;border:1px solid var(--border);border-radius:16px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoBoxSq img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .tiny{font-size:11px;color:#64748b}
  .itins{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px}
  .itinCol{border:1px solid var(--border);border-radius:14px;padding:12px}
  .itinOld{background:var(--old)} .itinNew{background:var(--new)}
  .leg{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffb0;margin-top:10px}
  .leg .hdrL{display:flex;justify-content:space-between;align-items:center}
  .leg .rt{font:600 14px Inter}
  .leg .meta{font-size:12px;color:#475569}
  .leg .times{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
  .leg .big{font:700 18px Inter}
  .prices{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px}
  .pill{border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;background:var(--muted)}
  .pill .v{font-weight:700}
  .foot{display:flex;justify-content:space-between;gap:12px;margin-top:16px;color:#64748b;font-size:12px;align-items:center}
  details{margin-top:10px;font-size:12px}
  details summary{cursor:pointer;color:#0b2a5a;font-weight:600}
  .badge-nc{position:absolute;top:10px;right:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b2a5a;font:700 11px Inter;padding:4px 8px;border-radius:10px;border:1px solid #ffffffa0}
</style>
</head>
<body>
  <div class="bar">
    <div class="wrap flex">
      <div class="flex" style="gap:10px">
        <div class="logoBox" style="height:48px;padding:6px 10px;max-width:220px">
          <img alt="Maarlab" src="https://maarlab.com/wp-content/uploads/2024/09/Logo-web.png" crossorigin="anonymous">
        </div>
        <div class="logoBoxSq" style="width:48px;height:48px">
          <img alt="M" src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg" crossorigin="anonymous">
        </div>
        <div>
          <h1>Visualizador de Cambios RT · Maarlab</h1>
          <div class="tiny">Itinerario anterior/nuevo • 4 vuelos • Moneda EUR/USD/MXN • PNG</div>
        </div>
      </div>
      <div class="grow"></div>
      <div class="chip" id="chipCurrency" style="margin-right:8px">
        <button data-cur="EUR" class="active">EUR</button>
        <button data-cur="USD">USD</button>
        <button data-cur="MXN">MXN</button>
      </div>
      <div class="chip">
        <button id="btnES" class="active">ES</button>
        <button id="btnEN">EN</button>
      </div>
    </div>
  </div>

  <div class="wrap grid">
    <!-- Panel -->
    <div class="card" id="panel">
      <h2>Ruta (ida)</h2>
      <div class="row">
        <label>Origen (IATA) <input id="outFrom" placeholder="TFN" data-iata="outFromCity"></label>
        <label>Ciudad origen <input id="outFromCity" placeholder="Tenerife Norte"></label>
        <label>Destino (IATA) <input id="outTo" placeholder="MAD" data-iata="outToCity"></label>
        <label>Ciudad destino <input id="outToCity" placeholder="Madrid"></label>
      </div>

      <h2 style="margin-top:12px">Ruta (vuelta)</h2>
      <div class="row">
        <label>Origen (IATA) <input id="retFrom" placeholder="MAD" data-iata="retFromCity"></label>
        <label>Ciudad origen <input id="retFromCity" placeholder="Madrid"></label>
        <label>Destino (IATA) <input id="retTo" placeholder="TFN" data-iata="retToCity"></label>
        <label>Ciudad destino <input id="retToCity" placeholder="Tenerife Norte"></label>
      </div>

      <h2 style="margin-top:14px">Itinerario anterior</h2>
      <div class="row">
        <label>Ida — Vuelo <input id="ooFlight" placeholder="IB3478"></label>
        <label>Ida — Fecha <input id="ooDate" type="date"></label>
        <label>Ida — Salida <input id="ooDep" placeholder="10:30"></label>
        <label>Ida — Llegada <input id="ooArr" placeholder="12:50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Vuelta — Vuelo <input id="orFlight" placeholder="IB3479"></label>
        <label>Vuelta — Fecha <input id="orDate" type="date"></label>
        <label>Vuelta — Salida <input id="orDep" placeholder="17:20"></label>
        <label>Vuelta — Llegada <input id="orArr" placeholder="19:35"></label>
      </div>

      <h2 style="margin-top:14px">Itinerario nuevo</h2>
      <div class="row">
        <label>Ida — Vuelo <input id="noFlight" placeholder="UX1234"></label>
        <label>Ida — Fecha <input id="noDate" type="date"></label>
        <label>Ida — Salida <input id="noDep" placeholder="11:15"></label>
        <label>Ida — Llegada <input id="noArr" placeholder="13:40"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Vuelta — Vuelo <input id="nrFlight" placeholder="UX1235"></label>
        <label>Vuelta — Fecha <input id="nrDate" type="date"></label>
        <label>Vuelta — Salida <input id="nrDep" placeholder="18:10"></label>
        <label>Vuelta — Llegada <input id="nrArr" placeholder="20:30"></label>
      </div>

      <h2 style="margin-top:14px">Costes</h2>
      <div class="row-3">
        <label>Penalización <input id="penalty" placeholder="150,00"></label>
        <label>Fee servicio <input id="fee" placeholder="30,00"></label>
        <label>Diferencia de tarifa <input id="fareDiff" placeholder="45,50"></label>
      </div>

      <h2 style="margin-top:14px">Hotel</h2>
      <div class="row">
        <label>Cadena <select id="chainSelect"></select></label>
        <label>Hotel <select id="hotelSelect"></select></label>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="ncAgree">
          <span class="tiny">Confirmo que este material es informativo y <b>no</b> tiene fines comerciales.</span>
        </label>
        <div class="grow"></div>
        <div class="tiny" id="noteCORS">Puedes exportar o hacer una captura de pantalla.</div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
        <button id="btnPng" class="btn" disabled>Exportar PNG</button>
      </div>

      <details id="adv" style="margin-top:12px">
        <summary>Opciones avanzadas</summary>
        <div class="row" style="margin-top:8px">
          <label>Logos aerolíneas (base URL) <input id="airlineBase" value=""></label>
          <label>Logo Maarlab horizontal (URL) <input id="maarlabURL" value=""></label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>Logo “M” Maarlab (URL) <input id="maarlabMarkURL" value=""></label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="fxEnable"> <span>Convertir desde EUR</span>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>1 EUR = USD <input id="fxUSD" value="1.08"></label>
          <label>1 EUR = MXN <input id="fxMXN" value="19.00"></label>
        </div>
      </details>
    </div>

    <!-- Tarjeta -->
    <div class="card" id="cardWrap" style="position:relative">
      <div class="band"></div>
      <div class="badge-nc">PREVIEW · Uso no comercial</div>

      <div class="flex" style="justify-content:space-between;align-items:center;gap:12px">
        <div class="logos" id="airlineLogos"></div>
        <div style="text-align:center;flex:1">
          <div class="tiny" id="hdr-sub">Cambio de vuelo · Round Trip</div>
          <div style="font:700 22px Poppins" id="hdr-title">Itinerario anterior → Itinerario nuevo</div>
          <div class="tiny" id="hdr-dates">Ida: — → — · Vuelta: — → —</div>
        </div>
        <div class="logos">
          <div class="logoBox"><img id="maarlabLogoH" alt="Maarlab" crossorigin="anonymous"></div>
          <div class="logoBoxSq" style="width:56px;height:56px"><img id="maarlabLogoM" alt="M" crossorigin="anonymous"></div>
        </div>
      </div>

      <div class="flex" style="gap:18px;margin-top:12px;justify-content:center">
        <div class="tiny" id="routeOut">IDA · XXX → XXX</div>
        <div class="tiny" id="routeRet">VUELTA · XXX → XXX</div>
      </div>

      <div class="itins">
        <div class="itinCol itinOld">
          <div style="font:700 14px Poppins">Itinerario anterior</div>
          <div class="leg">
            <div class="hdrL"><div class="rt" id="ooRt">IDA · XXX → XXX</div><div class="meta" id="ooMeta">Vuelo — Fecha</div></div>
            <div class="times"><div><div class="tiny">Salida</div><div class="big" id="ooDepLabel">--:--</div></div><div><div class="tiny">Llegada</div><div class="big" id="ooArrLabel">--:--</div></div></div>
          </div>
          <div class="leg">
            <div class="hdrL"><div class="rt" id="orRt">VUELTA · XXX → XXX</div><div class="meta" id="orMeta">Vuelo — Fecha</div></div>
            <div class="times"><div><div class="tiny">Salida</div><div class="big" id="orDepLabel">--:--</div></div><div><div class="tiny">Llegada</div><div class="big" id="orArrLabel">--:--</div></div></div>
          </div>
        </div>

        <div class="itinCol itinNew">
          <div style="font:700 14px Poppins">Itinerario nuevo</div>
          <div class="leg">
            <div class="hdrL"><div class="rt" id="noRt">IDA · XXX → XXX</div><div class="meta" id="noMeta">Vuelo — Fecha</div></div>
            <div class="times"><div><div class="tiny">Salida</div><div class="big" id="noDepLabel">--:--</div></div><div><div class="tiny">Llegada</div><div class="big" id="noArrLabel">--:--</div></div></div>
          </div>
          <div class="leg">
            <div class="hdrL"><div class="rt" id="nrRt">VUELTA · XXX → XXX</div><div class="meta" id="nrMeta">Vuelo — Fecha</div></div>
            <div class="times"><div><div class="tiny">Salida</div><div class="big" id="nrDepLabel">--:--</div></div><div><div class="tiny">Llegada</div><div class="big" id="nrArrLabel">--:--</div></div></div>
          </div>
        </div>
      </div>

      <div class="prices">
        <div class="pill"><div class="tiny" id="penLabel">Penalización</div><div class="v" id="penVal">€0,00</div></div>
        <div class="pill"><div class="tiny" id="feeLabel">Fee servicio</div><div class="v" id="feeVal">€0,00</div></div>
        <div class="pill"><div class="tiny" id="fareLabel">Diferencia de tarifa</div><div class="v" id="fareVal">€0,00</div></div>
        <div class="pill" style="background:#e6f7ff"><div class="tiny" id="totLabel">Total a cobrar</div><div class="v" id="totVal">€0,00</div></div>
      </div>

      <div class="foot">
        <div class="flex" style="align-items:center;gap:10px">
          <div class="logoBoxSq"><img id="hotelLogo" alt="hotel" crossorigin="anonymous"></div>
          <div><span id="hotelLabel">Hotel</span>: <span id="hotelVal">—</span></div>
        </div>
        <div><span id="genLabel">Generado por</span> Maarlab · <span id="contactLabel">Contacto</span>: booking@maarlab.com</div>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
/* ========= util ========= */
const $ = (id)=>document.getElementById(id);

/* ========= datos ========= */
const DEFAULT_AIRLINE_BASE = "https://maarlabcdnstorage.blob.core.windows.net/web-assets/images/airlines";
const DEFAULT_MAARLAB_LOGO = "https://maarlab.com/wp-content/uploads/2024/09/Logo-web.png";
const DEFAULT_MAARLAB_MARK = "https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg";

const HOTEL_CHAINS = {
  "Spring Hoteles": { hotels:[{ name:"Spring Hoteles (cadena)", logo:"https://www.viafirma.com/wp-content/uploads/2024/04/5f_d9oY_400x400-1.jpg" }] },
  "Landmar": { hotels:[
    { name:"Landmar Costa Los Gigantes", logo:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQTwXfh7P_vQa0CGmUDaOW3SO8AX287iOFc0TiZsuM2kdacfeZEcWx6IIUlDHRYOg7OdaI&usqp=CAU" },
    { name:"Landmar Playa La Arena", logo:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSwQaloIdtf8_if2DFl-M8ONyuOQgT6ryxX2Kp3Eqa9tsY40wiYT4t7UKWYGWVjUXxgbZc&usqp=CAU" }
  ]},
  "Park Royal Hotels & Resorts": { hotels:[
    { name:"Park Royal (cadena)", logo:"https://media.licdn.com/dms/image/v2/D4E0BAQHPYGg5SDVKOg/company-logo_200_200/company-logo_200_200/0/1730599344107/park_royal_hotels__resorts_logo?e=2147483647&v=beta&t=_-ZlXi2uHA1rIThUFZwkbuAS9AwNrGVZ5TFvR0n0TC4" }
  ]}
};

const IATA_DB = {
  "TFN":"Tenerife Norte","TFS":"Tenerife Sur","LPA":"Gran Canaria","ACE":"Lanzarote","FUE":"Fuerteventura",
  "MAD":"Madrid","BCN":"Barcelona","AGP":"Málaga","SVQ":"Sevilla","BIO":"Bilbao","VLC":"Valencia","PMI":"Palma de Mallorca","IBZ":"Ibiza",
  "LIS":"Lisboa","OPO":"Oporto","FAO":"Faro","CDG":"París (Charles de Gaulle)","ORY":"París (Orly)","NCE":"Niza","LYS":"Lyon",
  "LHR":"Londres (Heathrow)","LGW":"Londres (Gatwick)","LTN":"Londres (Luton)","STN":"Londres (Stansted)","MAN":"Mánchester","EDI":"Edimburgo",
  "FRA":"Fráncfort","MUC":"Múnich","BER":"Berlín","DUS":"Düsseldorf","HAM":"Hamburgo","AMS":"Ámsterdam","BRU":"Bruselas",
  "ZRH":"Zúrich","VIE":"Viena","DUB":"Dublín","CPH":"Copenhague","OSL":"Oslo","ARN":"Estocolmo","FCO":"Roma (Fiumicino)","MXP":"Milán (Malpensa)",
  "IST":"Estambul","ATH":"Atenas","MEX":"Ciudad de México","GDL":"Guadalajara","MTY":"Monterrey","CUN":"Cancún","PVR":"Puerto Vallarta",
  "SJD":"Los Cabos","CZM":"Cozumel","MID":"Mérida","BOG":"Bogotá","PTY":"Ciudad de Panamá","SJO":"San José","SAL":"San Salvador",
  "UIO":"Quito","GYE":"Guayaquil","LIM":"Lima","SCL":"Santiago de Chile","EZE":"Buenos Aires","GRU":"Sao Paulo (Guarulhos)","GIG":"Río de Janeiro",
  "JFK":"Nueva York (JFK)","EWR":"Newark","MIA":"Miami","LAX":"Los Ángeles","SFO":"San Francisco","ORD":"Chicago","DFW":"Dallas","ATL":"Atlanta"
};

/* ========= estado ========= */
let LANG="es";
let CUR="EUR";
let fmt = new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2});

/* ========= helpers ========= */
const nf = (cur,lang)=>new Intl.NumberFormat(lang==="en"?"en-US":"es-ES",{style:"currency",currency:cur,minimumFractionDigits:2,maximumFractionDigits:2});
const parseMoney = s => { const t=String(s||"").replace(/\./g,"").replace(",","."); const n=parseFloat(t); return isFinite(n)?n:0; };
const parseFlight = t => { const s=String(t||"").toUpperCase().replace(/\s+/g,""); const m=s.match(/^([A-Z]{2,3})(\d+[A-Z]?)$/); return m?{code:m[1],number:m[2]}:{code:"",number:s}; };

/* ========= inicialización ========= */
function initChains(){
  const cs = $("chainSelect"), hs = $("hotelSelect");
  if(!cs || !hs) return;
  cs.innerHTML = "";
  Object.keys(HOTEL_CHAINS).forEach(k=>{
    const o=document.createElement("option"); o.value=k; o.textContent=k; cs.appendChild(o);
  });
  cs.addEventListener("change", ()=>buildHotels());
  hs.addEventListener("change", ()=>refresh());
  buildHotels();
}
function buildHotels(){
  const cs=$("chainSelect"), hs=$("hotelSelect");
  hs.innerHTML="";
  const data = HOTEL_CHAINS[cs.value];
  if(!data) return;
  data.hotels.forEach(h=>{
    const o=document.createElement("option"); o.value=h.name; o.textContent=h.name; o.dataset.logo=h.logo; hs.appendChild(o);
  });
  refresh();
}

function iataAutoBind(){
  document.querySelectorAll('input[data-iata]').forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const city = $(inp.dataset.iata);
      const code = (inp.value||"").toUpperCase().trim();
      if(city && code.length>=3 && IATA_DB[code]) city.value = IATA_DB[code];
      refresh();
    });
    inp.addEventListener("blur", ()=>{
      const city = $(inp.dataset.iata);
      const code = (inp.value||"").toUpperCase().trim();
      if(city && IATA_DB[code]) city.value = IATA_DB[code];
      refresh();
    });
  });
}

function safeBindInputs(){
  // cualquier input/select refresca
  document.querySelectorAll("#panel input, #panel select").forEach(el=>{
    el.addEventListener("input", refresh);
    el.addEventListener("change", refresh);
  });
  const chip = $("chipCurrency");
  if (chip) chip.addEventListener("click", e=>{
    const b = e.target.closest("button"); if(!b) return;
    CUR = b.dataset.cur;
    chip.querySelectorAll("button").forEach(x=>x.classList.toggle("active", x===b));
    fmt = nf(CUR, LANG);
    refresh();
  });
  const es=$("btnES"), en=$("btnEN");
  if (es) es.addEventListener("click", ()=>{LANG="es"; es.classList.add("active"); en.classList.remove("active"); fmt=nf(CUR,LANG); refresh();});
  if (en) en.addEventListener("click", ()=>{LANG="en"; en.classList.add("active"); es.classList.remove("active"); fmt=nf(CUR,LANG); refresh();});

  const agree = $("ncAgree");
  const btn = $("btnPng");
  if (agree && btn) agree.addEventListener("change", ()=>{ btn.disabled = !agree.checked; });
}

function setHiddenDefaults(){
  const ab=$("airlineBase"), mh=$("maarlabURL"), mm=$("maarlabMarkURL");
  if (ab) ab.value ||= DEFAULT_AIRLINE_BASE;
  if (mh) mh.value ||= DEFAULT_MAARLAB_LOGO;
  if (mm) mm.value ||= DEFAULT_MAARLAB_MARK;
}

/* ========= render ========= */
function renderAirlineLogos(codes){
  const base = ($("airlineBase")?.value||DEFAULT_AIRLINE_BASE).replace(/\/$/,"");
  const box = $("airlineLogos"); if(!box) return;
  box.innerHTML="";
  [...new Set(codes.filter(Boolean))].slice(0,4).forEach(code=>{
    const wrap=document.createElement("div"); wrap.className="logoBox";
    const img=document.createElement("img"); img.crossOrigin="anonymous"; img.alt=code; img.src=`${base}/${code}.png`;
    img.onerror=()=>img.removeAttribute("src");
    wrap.appendChild(img); box.appendChild(wrap);
  });
}

function moneyOut(n){
  const fx = $("fxEnable")?.checked;
  let v = Number(n)||0;
  if(fx && CUR!=="EUR"){
    const usd = Number($("fxUSD")?.value||1.08);
    const mxn = Number($("fxMXN")?.value||19.0);
    if(CUR==="USD") v*=usd;
    if(CUR==="MXN") v*=mxn;
  }
  return fmt.format(v);
}

function refresh(){
  // rutas
  const outFrom = $("outFrom")?.value || "XXX";
  const outTo   = $("outTo")?.value   || "XXX";
  const retFrom = $("retFrom")?.value || "XXX";
  const retTo   = $("retTo")?.value   || "XXX";
  $("routeOut").textContent = `${LANG==="es"?"IDA":"OUTBOUND"} · ${outFrom} → ${outTo}`;
  $("routeRet").textContent = `${LANG==="es"?"VUELTA":"RETURN"} · ${retFrom} → ${retTo}`;

  // logos aerolínea
  const codes = [parseFlight($("ooFlight")?.value).code, parseFlight($("orFlight")?.value).code, parseFlight($("noFlight")?.value).code, parseFlight($("nrFlight")?.value).code]
    .map(c=>(c||"").toUpperCase());
  renderAirlineLogos(codes);

  // cabecera fechas
  $("hdr-dates").textContent = `${LANG==="es"?"Ida":"Out"}: ${$("ooDate")?.value||"—"} → ${$("noDate")?.value||"—"} · ${LANG==="es"?"Vuelta":"Return"}: ${$("orDate")?.value||"—"} → ${$("nrDate")?.value||"—"}`;

  // anterior
  $("ooRt").textContent = `${LANG==="es"?"IDA":"OUTBOUND"} · ${outFrom} → ${outTo}`;
  $("orRt").textContent = `${LANG==="es"?"VUELTA":"RETURN"} · ${retFrom} → ${retTo}`;
  $("ooMeta").textContent = `${$("ooFlight")?.value||"—"} · ${$("ooDate")?.value||"—"}`;
  $("orMeta").textContent = `${$("orFlight")?.value||"—"} · ${$("orDate")?.value||"—"}`;
  $("ooDepLabel").textContent = $("ooDep")?.value||"--:--";
  $("ooArrLabel").textContent = $("ooArr")?.value||"--:--";
  $("orDepLabel").textContent = $("orDep")?.value||"--:--";
  $("orArrLabel").textContent = $("orArr")?.value||"--:--";

  // nuevo
  $("noRt").textContent = `${LANG==="es"?"IDA":"OUTBOUND"} · ${outFrom} → ${outTo}`;
  $("nrRt").textContent = `${LANG==="es"?"VUELTA":"RETURN"} · ${retFrom} → ${retTo}`;
  $("noMeta").textContent = `${$("noFlight")?.value||"—"} · ${$("noDate")?.value||"—"}`;
  $("nrMeta").textContent = `${$("nrFlight")?.value||"—"} · ${$("nrDate")?.value||"—"}`;
  $("noDepLabel").textContent = $("noDep")?.value||"--:--";
  $("noArrLabel").textContent = $("noArr")?.value||"--:--";
  $("nrDepLabel").textContent = $("nrDep")?.value||"--:--";
  $("nrArrLabel").textContent = $("nrArr")?.value||"--:--";

  // precios
  const p=parseMoney($("penalty")?.value), f=parseMoney($("fee")?.value), d=parseMoney($("fareDiff")?.value);
  $("penVal").textContent = moneyOut(p);
  $("feeVal").textContent = moneyOut(f);
  $("fareVal").textContent = moneyOut(d);
  $("totVal").textContent = moneyOut(p+f+d);

  // hotel
  const hs = $("hotelSelect");
  const opt = hs && hs.selectedOptions && hs.selectedOptions[0];
  $("hotelVal").textContent = opt ? opt.value : "—";
  const hImg = $("hotelLogo"); if (hImg) { hImg.src = opt?.dataset.logo || ""; hImg.onerror = ()=>hImg.removeAttribute("src"); }

  // logos maarlab
  const mh=$("maarlabURL")?.value||DEFAULT_MAARLAB_LOGO;
  const mm=$("maarlabMarkURL")?.value||DEFAULT_MAARLAB_MARK;
  const mhImg=$("maarlabLogoH"), mmImg=$("maarlabLogoM");
  if(mhImg){ mhImg.src=mh; mhImg.onerror=()=>mhImg.removeAttribute("src"); }
  if(mmImg){ mmImg.src=mm; mmImg.onerror=()=>mmImg.removeAttribute("src"); }
}

/* ========= export ========= */
function bindExport(){
  const btn=$("btnPng");
  if(!btn) return;
  btn.addEventListener("click", async ()=>{
    if(!$("ncAgree")?.checked){
      alert("Debes confirmar que el uso es informativo y no comercial.");
      return;
    }
    try{
      const dataUrl = await htmlToImage.toPng($("cardWrap"), {pixelRatio:2, cacheBust:true});
      const out=$("outFrom")?.value||"XXX", to=$("outTo")?.value||"XXX", r1=$("retFrom")?.value||"XXX", r2=$("retTo")?.value||"XXX";
      const when = $("nrDate")?.value || $("noDate")?.value || $("orDate")?.value || $("ooDate")?.value || "date";
      const a=document.createElement("a"); a.href=dataUrl; a.download=`${out}-${to}_${r1}-${r2}-${when}.png`.replace(/\s+/g,"_"); a.click();
    }catch(e){
      alert("No se pudo exportar. Puedes hacer captura de pantalla. Para PNG con logos remotos, activa CORS o sirve imágenes desde el mismo dominio.");
      console.error(e);
    }
  });
}

/* ========= start ========= */
(function start(){
  setHiddenDefaults();
  initChains();
  iataAutoBind();
  safeBindInputs();
  bindExport();
  refresh(); // primer render
})();
</script>
</body>
</html>
